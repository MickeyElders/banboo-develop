# C++ 视觉系统与PLC通信协议 (简化版)

## 概述

本协议定义了C++视觉系统与PLC之间的Modbus TCP通信，采用"视觉系统作为服务器，PLC作为客户端"的架构。**视觉系统主动推送坐标，PLC被动接收**。

## 核心原则

- **简化通信**：PLC主要关注坐标信息
- **直线导轨**：只有X坐标变化，无Y坐标
- **主动推送**：视觉系统主动写入坐标到寄存器
- **被动接收**：PLC监控坐标就绪标志，被动接收数据

## 寄存器映射 (简化版)

### 坐标数据寄存器 (40001-40010)

| 寄存器地址 | 数据类型 | 描述 | 值范围 |
|-----------|---------|------|--------|
| 40001 | INT16 | 系统状态 | 0=停止, 1=运行, 2=错误, 3=暂停, 4=紧急停止, 5=维护模式 |
| 40002 | INT16 | PLC命令 | 0=无, 1=进料检测, 2=切割准备, 3=切割完成, 4=启动送料, 5=暂停, 6=紧急停止, 7=恢复运行 |
| 40003 | INT16 | 坐标就绪标志 | 0=无坐标, 1=有坐标 |
| 40004-40005 | INT32 | X坐标 (导轨位置) | 0-10000 (0.1mm精度) |
| 40006 | INT16 | 切割质量 | 0=正常, 1=异常 |
| 40007-40008 | INT32 | 心跳计数器 | 0-4294967295 (递增) |
| 40009 | INT16 | 刀片编号 | 0=无, 1=刀片1, 2=刀片2, 3=双刀片 |
| 40010 | INT16 | 系统健康状态 | 0=正常, 1=警告, 2=错误, 3=严重错误 |

### 数据格式说明

- **X坐标 (40004-40005)**：导轨位置，单位0.1mm，范围0-10000，32位整数
- **切割质量 (40006)**：基于视觉检测的切割质量评估
- **心跳计数器 (40007-40008)**：视觉系统每100ms递增，用于检测连接状态，32位整数
- **刀片编号 (40009)**：切割刀片选择，1=刀片1, 2=刀片2, 3=双刀片同时
- **系统健康状态 (40010)**：系统整体健康状态，用于故障诊断和预防性维护

## 通信流程

### 1. 初始化阶段
```
视觉系统启动 → 监听Modbus TCP端口 → 等待PLC连接
PLC连接 → 读取系统状态 → 确认通信正常
视觉系统开始心跳计数 → 每50ms递增40006
PLC监控心跳计数器 → 检测连接状态
```

### 2. 正常工作流程
```
PLC发送"进料检测" (40002=1)
    ↓
视觉系统开始检测竹材
    ↓
检测到竹材 → 计算X坐标和刀片编号 → 写入寄存器
    ↓
设置"坐标就绪" (40003=1)
    ↓
PLC监控到坐标就绪 → 读取X坐标和刀片编号
    ↓
PLC拖动切割点到位置 → 夹持固定竹材
    ↓
PLC发送"切割准备" (40002=2)
    ↓
PLC根据刀片编号执行切割 → 发送"切割完成" (40002=3)
    ↓
视觉系统清除坐标就绪 → 准备下一次检测
```

### 3. 紧急停止流程
```
检测到紧急停止信号 → PLC发送"紧急停止" (40002=6)
    ↓
视觉系统立即停止检测 → 设置系统状态为"紧急停止" (40001=4)
    ↓
PLC停止所有机械动作 → 等待操作员确认
    ↓
操作员确认安全 → PLC发送"恢复运行" (40002=7)
    ↓
视觉系统重新初始化 → 恢复正常工作流程
```

### 4. 暂停/恢复流程
```
PLC发送"暂停" (40002=5) → 视觉系统暂停检测
    ↓
PLC完成当前操作 → 等待操作员指令
    ↓
操作员确认继续 → PLC发送"恢复运行" (40002=7)
    ↓
视觉系统恢复检测 → 继续正常工作流程
```

### 5. 无坐标情况
```
视觉系统检测无竹材 → 设置"无坐标" (40003=0)
    ↓
PLC检测到无坐标 → 发送"启动送料" (40002=4)
    ↓
启动送料滚筒 → 等待新竹材
```

## 数据示例

### 检测到竹材
```
40001: 1 (系统运行)
40002: 0 (无PLC命令)
40003: 1 (坐标就绪)
40004: 2500 (X坐标=250.0mm)
40005: 0 (切割质量正常)
40006: 12345 (心跳计数器)
40007: 3 (双刀片同时切割)
```

### 无竹材
```
40001: 1 (系统运行)
40002: 0 (无PLC命令)
40003: 0 (无坐标)
40004: 0 (无效坐标)
40005: 0 (无质量评估)
40006: 12346 (心跳计数器递增)
40007: 0 (无刀片选择)
```

## 错误处理

### 通信错误
- PLC连接断开：视觉系统继续检测，等待重连
- 寄存器写入失败：视觉系统记录错误，继续运行
- 数据校验失败：PLC忽略当前数据，等待下一次更新
- 心跳超时：PLC检测到40006停止递增超过500ms，判定连接异常
- 心跳恢复：PLC检测到40006重新递增，恢复正常工作

### 系统错误
- 视觉系统错误：设置40001=2，PLC停止切割操作
- 坐标异常：设置40005=1，PLC可选择性执行切割

### 超时处理
- 进料检测超时：PLC发送"进料检测"后15秒内无坐标，PLC发送"启动送料"
- 夹持固定超时：PLC读取坐标后60秒内未发送"切割准备"，视觉系统清除坐标就绪
- 切割执行超时：PLC发送"切割准备"后120秒内未发送"切割完成"，视觉系统记录异常
- 心跳超时恢复：PLC检测到心跳恢复后，重新发送"进料检测"命令

### 安全处理
- 紧急停止：优先级最高，立即停止所有操作
- 系统健康监控：持续监控40008，异常时自动降级
- 故障安全：通信中断时，PLC进入安全模式
- 操作员确认：关键操作需要操作员确认

## 性能要求

- **响应时间**：坐标检测到写入寄存器 < 50ms
- **通信频率**：视觉系统每20ms更新一次坐标数据
- **心跳频率**：视觉系统每20ms递增心跳计数器
- **数据精度**：X坐标精度0.1mm
- **连接稳定性**：支持断线重连，数据不丢失
- **超时设置**：进料检测15秒，夹持固定60秒，切割执行120秒
- **安全响应**：紧急停止响应时间 < 100ms

## 实现要点

### C++视觉系统
- 使用libmodbus库实现Modbus TCP服务器
- 实时检测竹材位置，计算X坐标
- 主动写入寄存器，无需等待PLC请求
- 实现断线重连和错误恢复机制

### PLC客户端
- 发送"进料检测"命令(40002=1)启动检测
- 定期读取坐标就绪标志(40003)
- 检测到坐标就绪时读取X坐标(40004)和刀片编号(40007)
- 拖动切割点到指定位置并夹持固定
- 发送"切割准备"命令(40002=2)
- 根据刀片编号执行切割操作
- 发送"切割完成"命令(40002=3)
- 监控心跳计数器(40006)，检测连接状态
- 心跳超时时暂停切割操作，等待连接恢复
- 超时处理：进料检测30秒，夹持固定60秒，切割执行120秒
- 心跳计数器溢出处理：每4294967295次后重置为0

这个简化协议专注于坐标传递，减少了PLC的处理负担，提高了系统效率。
 