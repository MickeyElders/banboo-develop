# PLC 通信与动作指令文档

## 1. 概述

本文件面向 PLC 团队，阐述视觉系统（Modbus TCP 客户端）与 PLC（Modbus TCP 服务器）之间的通信协议、寄存器映射、动作时序以及多动作协调策略。视觉系统负责识别竹材、产出坐标及尾料判定，并将状态写入 PLC 暴露的寄存器；PLC 根据寄存器变化驱动送料、夹持、切割以及尾料处理等动作。

## 2. 系统角色与通信方式

### 2.1 角色划分

- **视觉系统（客户端）**：运行在 IPC 上的 C++ 程序，主动连接 PLC 的 Modbus TCP 服务器，按周期读取/写入寄存器。负责发布检测结果、坐标、刀具建议以及健康状态，并维护心跳。
- **PLC（服务器）**：开放 Modbus TCP 服务（默认 502 端口，可配置）。负责维护寄存器地址空间、响应读写请求，并根据寄存器变化驱动设备动作，向视觉侧写入动作指令。

### 2.2 连接握手

1. PLC 上电后启动 Modbus TCP Server，并进入待命模式。
2. 视觉系统作为客户端建立 TCP 连接，若连接断开需自动重连，重连期间 PLC 保持最近一次寄存器值。
3. 视觉系统连接成功后立即：
   - 读取 PLC 指令寄存器（40002）、处理模式（40019）和数字输入状态，确认 PLC 当前意图；
   - 将系统状态（40001）置为 `1=运行`，并启动心跳计数器（40007-40008，每 20 ms 递增）。
4. PLC 在运行中需要持续监看心跳，如 500 ms 内无递增则进入通信异常流程。

## 3. 寄存器映射

寄存器按“数据所有者”划分：谁负责更新该寄存器，另一方只读或根据协议写入特定位。除特别说明外，所有地址均位于 Holding Register 区域。

### 3.1 视觉系统发布（由视觉写入，PLC 只读）

| 地址 | 长度 | 名称 | 描述与取值 |
|------|------|------|------------|
| 40001 | INT16 | 系统状态 | 0=停止，1=运行，2=错误，3=暂停，4=紧急停机，5=维护。用于告知 PLC 当前视觉可用性。 |
| 40003 | INT16 | 坐标就绪标志 | 0=无坐标/待机，1=坐标可读，2=正在复核，3=重复检测中。置 1 前需完成 40004-40005 更新。 |
| 40004-40005 | INT32 | X 坐标 | 单位 0.1 mm，正向为导轨正向。视觉检测到有效切割点后写入。 |
| 40006 | INT16 | 切割质量 | 0=正常，1=异常；可扩展其他质量码。 |
| 40007-40008 | INT32 | 心跳计数器 | 视觉每 20 ms 递增一次，溢出后回到 0。 |
| 40009 | INT16 | 刀片编号 | 0=未指定，1=刀 1，2=刀 2，3=双刀。 |
| 40010 | INT16 | 系统健康度 | 0=正常，1=警告，2=错误，3=严重错误。 |
| 40011 | INT16 | 尾料检测状态 | 0=空闲/可上料，1=检测进行中，2=结果可取，3=重新检测，9=判定尾料，10=尾料推送完成。 |
| 40014 | INT16 | 导轨方向建议 | 0=正向加工，1=反向（用于尾料推出）。PLC 可依据自身逻辑决定是否采用。 |
| 40015-40016 | INT32 | 剩余长度 | 单位 0.1 mm，用于尾料估算或下一刀的参考。 |
| 40017 | INT16 | 覆盖率 | 0-100，表示有效截面覆盖率；用于 PLC 判断是否需要重复检测。 |

### 3.2 PLC 发布（由 PLC 写入，视觉只读）

| 地址 | 长度 | 名称 | 描述与取值 |
|------|------|------|------------|
| 40002 | INT16 | PLC 命令 | 0=空闲，1=进料检测，2=切割准备，3=切割完成，4=启动送料，5=暂停，6=紧急停机，7=恢复运行，8=重复检测，9=尾料处理。 |
| 40012 | INT16 | 备用/扩展 | 预留给 PLC 输出即时报警码或夹持状态（可选实现）。 |
| 40018 | INT16 | 进料速度档 | 0=默认，1-5=不同速度配置（可扩展）。 |
| 40019 | INT16 | 处理模式 | 0=自动，1=手动，2=维护。视觉读取后决定是否参与流程。 |

> 说明：若 PLC 需要视觉执行额外服务（例如重新标定），可另行分配地址 40020-40030，并在双方版本对齐后写入该表。

### 3.3 PLC 本地数字 IO 约定

- **DI**
  - `DI_PE_IN`: 识别区光电（1=有料进入识别区）
  - `DI_PE_EXIT`: 出口光电（1=物料到达出口）
  - `DI_CLAMP_OK`: 夹持到位
- **DO**
  - `DO_ROLLER_EN`: 送料滚筒启停（1=运行）
  - `DO_ROLLER_DIR`: 送料方向（0=正向进料，1=反向推出）
  - `DO_CLAMP`: 夹持气缸（1=夹紧）
  - `DO_CUTTER`: 刀具执行（1=切割）
  - `DO_RAIL_EN`: 导轨伺服使能（1=运行）

## 4. 关键状态与命令

### 4.1 PLC 命令寄存器（40002）

| 值 | 说明 | 视觉侧响应 |
|----|------|------------|
| 1 | 进料检测 | 将 `40011` 置 1，开始采集；若检测窗口内无物料，返回 0。 |
| 2 | 切割准备 | 视觉保持坐标不变，等待 PLC 切刀。 |
| 3 | 切割完成 | 视觉清理 `40003` 和 `40004-40005`，准备下一次检测。 |
| 4 | 启动送料 | PLC 自行驱动送料，同时视觉重置 `40011=0`。 |
| 5 | 暂停 | 视觉停止更新寄存器，仅维持心跳。 |
| 6 | 紧急停机 | 视觉将 `40001=4` 并清除坐标。 |
| 7 | 恢复运行 | 视觉重新置 `40001=1`，重启检测。 |
| 8 | 重复检测 | 视觉在当前物料上重新采集，将 `40011=3`。 |
| 9 | 尾料处理 | 视觉保持检测暂停，引导 PLC 走尾料流程。 |

### 4.2 尾料检测状态（40011）

| 值 | 说明 |
|----|------|
| 0 | 空闲，可接受新料。 |
| 1 | 检测进行中，视觉忙。 |
| 2 | 检测完成，结果可取（检查 `40003`/`40004-40005` 或 `40011=9`）。 |
| 3 | 重复检测中，PLC 维持当前位置。 |
| 9 | 明确判定为尾料，PLC 需执行尾料丢弃流程。 |
| 10 | 尾料已经推出，视觉可恢复送料。 |

### 4.3 系统状态（40001）

| 值 | 说明 | 建议动作 |
|----|------|----------|
| 0 | 停止 | PLC 停止送料并等待视觉恢复。 |
| 1 | 运行 | 正常工作。 |
| 2 | 错误 | PLC 进入安全模式，等待 `40002=7`。 |
| 3 | 暂停 | 视觉暂停检测，PLC 保持位置。 |
| 4 | 紧急停机 | 所有运动立即停止。 |
| 5 | 维护 | 手动调试，PLC 不应自动送料。 |

## 5. 多动作流程

### 5.1 初始化与安全检查

1. PLC 完成急停、门禁、气源等安全自检。
2. PLC 将 `40019` 写为需要的处理模式（通常为 0 自动），并把 `40002` 置 7 触发视觉恢复。
3. 视觉确认心跳开始后，置 `40001=1`、`40011=0`、`40003=0`，表示系统待机。
4. 双方完成上述握手后进入正常循环。

### 5.2 主循环与状态机

PLC 每个扫描周期执行：

```text
1. 读取 40011 / 40003 / 40002。
2. 根据 40011 的状态选择流程：
   - 0：触发送料与进料检测。
   - 1：等待视觉完成检测。
   - 2：根据坐标或尾料状态执行切割或尾料流程。
   - 3：保持送料停止，等待视觉重复检测完成。
   - 9：立即进入尾料丢弃。
```

### 5.3 送料与检测启动

1. PLC 置 `DO_ROLLER_DIR=0`、`DO_ROLLER_EN=1`，同时写 `40002=4`（启动送料）用于日志。
2. 识别区光电 `DI_PE_IN` 触发后，PLC 写 `40002=1`（进料检测），并将 `T_DET` 计时器启动（15 s）。
3. 视觉检测开始：`40011` 从 0 置 1，并清 `40003`、`40004-40005`。
4. 送料保持运行直到视觉给出结论。

### 5.4 视觉结果交互

视觉端处理：

1. 正常料：写入 `40004-40005`、`40009`、`40006`，最后置 `40003=1`，并把 `40011=2`。
2. 尾料：直接将 `40011=9`，可选写入剩余长度 `40015-40016`。
3. 需重新检测：把 `40011=3`，复测后恢复为 2。

PLC 侧判断：

```text
- 若 40011=9 -> 跳转尾料流程。
- 若 40003=1 且坐标非零 -> 停止送料 (DO_ROLLER_EN=0)，进入切割流程。
- 若 40003=0 且 40011=2 -> 视为无坐标，回到送料流程。
```

### 5.5 切割执行

1. **定位**：读取 `40004-40005`，换算成毫米（值 / 10）。停止送料并启动导轨伺服移动。
2. **夹持**：`DO_CLAMP=1`，监控 `DI_CLAMP_OK`，超时（60 s）则进入异常。
3. **切割准备**：PLC 写 `40002=2`，根据 `40009` 选择刀具、启动 `T_CUT=120 s`。
4. **切割执行**：`DO_CUTTER=1`，完成后 `DO_CUTTER=0`，并写 `40002=3`。
5. **收尾**：释放夹持，更新内部剩余长度并把 `40003`、`40011` 清为 0，等待下一轮送料。

### 5.6 尾料丢弃

1. PLC 停止送料 200 ms，切换 `DO_ROLLER_DIR=1`，再置 `DO_ROLLER_EN=1` 反向推出。
2. 监控 `DI_PE_IN` 下降沿与 `DI_PE_EXIT` 上升沿，确认尾料离开（超时 10 s 触发异常）。
3. 尾料推出后，PLC 停止送料并写 `40011=10`，视觉接收到 10 后复位为 0 并允许重新送料。

### 5.7 重复检测

当 `40017`（覆盖率）低于阈值或 PLC 判断定位需要复核时：

1. PLC 写 `40002=8`，视觉收到后设置 `40011=3` 并重新检测。
2. 复测成功后重新写坐标并把 `40011=2`。

### 5.8 异常与超时

- **通信异常**：PLC 每 100 ms 读取心跳（40007-40008）。若 500 ms 未递增，置系统状态 `40001=2` 并停机；重连后写 `40002=7` 使视觉恢复。
- **检测超时（15 s）**：PLC 写 `40002=4` 强制重新送料，同时视觉需清 `40011`。
- **夹持 / 切割超时**：PLC 停止当前动作并置 `40001=2`，等待人工干预。
- **紧急停机**：任一方检测到急停，PLC 写 `40002=6`，视觉写 `40001=4`，所有执行机构断电。恢复时需 `40002=7`。

### 5.9 自适应控制

- PLC 可通过 `40018` 调整送料/导轨速度档位；视觉记录该值便于日志对齐。
- 根据剩余长度 `40015-40016` 和覆盖率 `40017`，PLC 可切换至精细模式（降低送料速度、缩小窗口）。

## 6. 实施建议

- 视觉侧每 20 ms 执行一次批量写入，避免频繁单寄存器操作。
- 所有状态转换需遵守“先写数据，后写标志”的顺序（如先写坐标再置 `40003=1`），防止 PLC 读到不一致数据。
- PLC 对 `40002` 命令值需保持脉冲式写入：写入后等待视觉响应，再写 0 收尾，便于日志分析。
- 若未来扩展 Y 轴或更多刀具，可在 40030 之后预留新区段，并更新此文档同步给双方团队。
