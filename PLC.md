# PLC动作流程文档 (详细版)

## 概述

本文档详细描述了智能切竹机PLC在尾料检测系统中的完整动作流程，包括具体的寄存器操作、时序控制和尾料处理策略。

## 系统状态定义

### 核心寄存器
- **40001**: 系统状态 (0=停止, 1=运行, 2=错误, 3=暂停, 4=紧急停止)
- **40002**: PLC命令 (0=无, 1=进料检测, 2=切割准备, 3=切割完成, 4=启动送料)
- **40003**: 坐标就绪标志 (0=无坐标, 1=有坐标)
- **40004-05**: X坐标 (32位, 0.1mm精度)
- **40006**: 切割质量 (0=正常, 1=异常)
- **40007-08**: 心跳计数器 (32位)
- **40009**: 刀片编号 (0=无, 1=刀片1, 2=刀片2, 3=双刀片)

### 废料检测专用寄存器
- **40011**: 废料检测状态 (0=不是废料, 1=是废料)


### I/O 信号约定（PLC本地）
- 数字量输入（DI）
  - DI_PE_IN: 识别区光电（1=有料进入识别区）
  - DI_PE_EXIT: 退出口光电（1=物料已被推出至出口）
  - DI_CLAMP_OK: 夹持到位
- 数字量输出（DO）
  - DO_ROLLER_EN: 送料滚筒启停（1=运行）
  - DO_ROLLER_DIR: 送料方向（0=正向进料，1=反向推出）
  - DO_CLAMP: 夹持气缸（1=夹紧）
  - DO_CUTTER: 刀具执行（1=切割）
  - DO_RAIL_EN: 导轨使能（1=运行）

## 详细动作流程

### 1. 系统初始化流程

```
步骤1: 通信连接验证
- 作用: 确认PLC与视觉系统（作为Modbus TCP服务器）之间的通信链路正常工作，心跳机制确保持续连接活性。
- 读取心跳计数器 (40007-08)
- 检查心跳是否正常递增
- 如果心跳停止，尝试重新连接


步骤2: 安全检查
- 作用: 在系统进入运行状态前，执行全面的硬件和安全防护检查，避免因安全隐患导致设备损坏或人员伤害。
- 检查急停按钮状态
- 检查安全门状态
- 检查气压/液压系统
- 检查所有传感器状态

步骤3: 进入运行模式
- 作用: PLC通知系统进入正式工作状态，同时复位相关状态标志，为新的检测和处理循环做准备。
- 写入处理模式: 0 (自动)  // PLC写入 40019，告知视觉系统当前处理模式为自动 (R/W)
- [逻辑说明]: 系统状态(40001)、尾料检测状态(40011)、导轨方向(40014)等寄存器由视觉系统负责写入和维护，PLC在初始化时仅作读取确认，不应写入。若需PLC驱动视觉系统进入运行状态，PLC应发送特定的PLC命令（如40002=7），而非直接写入视觉维护的只读状态寄存器。
```

### 2. 正常检测主循环

```
主循环开始:
步骤1: 读取当前状态
- 作用: 获取系统当前关键状态参数，为后续的流程判断和决策提供最新数据。
- 读取尾料检测状态 (40011)
- 读取导轨方向 (40014)
- 读取剩余长度 (40015-16)
- 读取覆盖率 (40017)

步骤2: 状态判断与分支
IF 尾料检测状态 = 0 THEN
    执行启动检测流程
ELSE IF 尾料检测状态 = 1 THEN
    // 视觉系统正在检测中，PLC保持当前送料状态，继续等待视觉结果或超时。
    // 无需跳转到独立流程，继续在主循环中等待。
ELSE IF 尾料检测状态 = 2 THEN
    执行处理结果流程
ELSE IF 尾料检测状态 = 3 THEN
    执行重复检测处理流程
END IF

步骤3: 超时检查
- 作用: 监控各项操作的执行时间，防止设备因长时间等待或故障而卡死，及时触发异常处理。
- 检查夹持超时 (60秒)
- 检查切割超时 (120秒)
- 检查检测超时 (15秒)

步骤4: 心跳更新
- 作用: 维持PLC与视觉系统之间的通信活性，并提供一种简单的通信健康检查机制。
- 递增心跳计数器 (40007-08)
- 检查通信状态

主循环结束，等待下一个周期 (20ms)
```

### 3. 启动检测流程（送料→到识别区→通知视觉）

```
步骤1: 启动送料
- 作用: 启动滚筒，使待加工物料进入机器内部，为视觉检测做物理准备。
- DO_ROLLER_DIR=0（正向进料）
- DO_ROLLER_EN=1（滚筒运行）
- 写入40002=4（启动送料指令，供上位/视觉监控）

步骤2: 检测进入识别区
- 作用: 利用光电传感器精确判断物料是否已进入视觉识别区域，作为触发视觉系统开始检测的信号。
- 监控 DI_PE_IN 上升沿（=1）
- 触发后：写入40002=1（进料检测），清40003=0（清坐标就绪）
- 启动 T_DET=15s 等待视觉结果计时器

步骤3: 等待视觉识别开始
- 作用: 在物料进入识别区后，PLC保持送料滚筒运行，确保物料持续移动，直到视觉系统开始处理并提供结果。
- 送料保持运行（不中断），进入“通知视觉/等待结果”流程
```

### 4. 通知视觉/等待结果（送料不中断直至拿到结果）

```
步骤1: 视觉侧输出规则（供说明）
- 作用: 明确视觉系统向PLC报告检测结果的标准方式，包括尾料判定和正常料坐标。
- 若判定“尾料”：写 40011=9（或采用兼容约定），可选写入剩余长度至40015-16
- 若判定“正常料”：写入 40004-05 坐标，置 40003=1（坐标就绪）

步骤2: PLC判定分支
IF 40011=9 THEN
    // 视觉判定尾料
    跳转到“尾料丢弃流程”
ELSE IF 40003=1 且 (40004-05 ≠ 0) THEN
    // 正常料，获取坐标
    DO_ROLLER_EN=0（停止送料）
    跳转到“切割执行流程”
END IF
ELSE IF 40003 = 0 且 40004-05 = 0 THEN
    // 无切割点
    DO_ROLLER_EN=0（停止送料）
    跳转到“回到滚筒送料”
END IF

END IF
```

### 5. 切割执行流程

```
步骤1: 位置移动
- 作用: PLC根据视觉系统提供的坐标，精确控制导轨移动，将物料定位到切割点。
- 读取检测坐标 (40004-05)
- 计算目标位置: 目标位置 = 寄存器值 / 10.0
- 停止滚筒运动
- 启动精确定位运动
- 移动到目标位置
- 等待位置到达确认 (±0.1mm精度)

步骤2: 夹持固定
- 作用: 启动气缸夹紧物料，确保在切割过程中物料稳定，防止位移，保证切割精度和安全。
- 启动夹持气缸
- 等待夹持确认信号
- 启动夹持超时计时器 (60秒)

步骤3: 切割准备
- 作用: PLC根据预设的刀片配置，准备刀具，进入待切割状态。同时设置PLC命令，供上位机监控。
- 写入PLC命令: 2 (切割准备)
- 根据刀片编号选择切割方式:
  CASE 1: 激活刀片1
  CASE 2: 激活刀片2  
  CASE 3: 激活刀片1和刀片2
- 启动切割超时计时器 (120秒)

步骤4: 执行切割
- 作用: 实际执行刀具切割操作，完成物料的剪切。
- 启动切割运动
- 监控切割过程
- 等待切割完成信号
- 检查切割质量

步骤5: 切割完成
- 作用: 切割操作完成后，PLC复位相关状态，释放夹持，并更新剩余长度信息，为下一个切割周期做准备。
- 写入PLC命令: 3 (切割完成)
- 释放夹持气缸
- 更新剩余长度计算
- 重置所有计时器
```

### 6. 废料丢弃流程（视觉判定尾料→PLC直接推出）

```
步骤1: 送料方向切换
- 作用: 将送料滚筒从正向进料切换为反向推出，准备将尾料从机器出口排出。短暂延时确保机械动作平稳。
- DO_ROLLER_EN=0，延时50~200ms（机械间隙/防抖）
- DO_ROLLER_DIR=1（反向推出）
- DO_ROLLER_EN=1（开始反向推出）

步骤2: 推出确认
- 作用: 监控光电传感器信号，确认尾料已完全离开识别区并到达出口，确保推出操作完成。
- 等待 DI_PE_IN=0（识别区无料）
- 同时等待 DI_PE_EXIT=1（尾料到达出口）
- 如超时 T_REJECT=10s：进入异常处理流程

步骤3: 收尾与复位
- 作用: 停止滚筒运动，并清零相关状态寄存器，将系统恢复到可接受新物料的状态，准备开始下一个循环。
- DO_ROLLER_EN=0（停止滚筒）
- 清 40011（置0）、清 40002（置0）、清 40003（置0）
- 返回“启动检测流程”（继续下一根）
```

### 9. 异常处理流程

```
步骤1: 通信错误处理
- 作用: 监控PLC与视觉系统间的心跳，一旦通信异常，则触发报警，并尝试恢复连接，防止系统长时间离线。
- 检查心跳计数器 (40007-08)
- 计算心跳间隔
IF 心跳间隔 > 5秒 THEN
    设置系统状态: 2 (错误)
    尝试重新连接
    如果重连失败，进入安全模式
END IF

步骤2: 超时处理
- 作用: 处理各种操作（夹持、切割、检测）的超时情况，采取相应措施（释放夹持、停止运动、恢复送料等），避免设备损伤或流程卡死。
- 夹持超时 (60秒):
    释放夹持气缸
    设置系统健康状态: 1 (警告)
    记录错误日志
  
- 切割超时 (120秒):
    停止切割运动
    设置系统健康状态: 2 (错误)
    进入安全模式
  
- 检测超时 (15秒):
    写入PLC命令: 4 (启动送料)
    重置检测状态

步骤3: 安全模式
- 作用: 在发生严重异常或紧急情况时，系统进入安全模式，立即停止所有运动，释放执行机构，确保人机安全，等待操作员介入。
- 停止所有运动
- 释放夹持气缸
- 设置系统状态: 4 (紧急停止)
- 等待操作员确认
- 操作员确认后恢复运行
```

### 10. 自适应控制流程

```
步骤1: 速度自适应控制
- 调整导轨速度（触摸屏）
- 设置导轨速度
- 更新运动参数

```