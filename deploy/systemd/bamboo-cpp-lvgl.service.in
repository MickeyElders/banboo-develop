[Unit]
Description=AI Bamboo Recognition System - C++ LVGL Wayland Edition
Documentation=https://github.com/bamboo-industries/bamboo-recognition
After=network.target multi-user.target
Wants=multi-user.target

[Service]
Type=simple
User=root
Group=root
WorkingDirectory=@CMAKE_INSTALL_PREFIX@/bin
ExecStart=@CMAKE_INSTALL_PREFIX@/bin/bamboo_integrated --verbose --config @CMAKE_INSTALL_PREFIX@/share/bamboo/config/system_config.yaml
ExecReload=/bin/kill -USR1 $MAINPID
ExecStop=/bin/kill -TERM $MAINPID

# ç¯å¢ƒå˜é‡
Environment="PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
Environment="LD_LIBRARY_PATH=/usr/local/lib:/usr/local/cuda/lib64:/usr/lib/aarch64-linux-gnu"
Environment="XDG_RUNTIME_DIR=/run/user/0"
Environment="HOME=/root"

# Wayland æ˜¾ç¤ºè®¾ç½®ï¼ˆæ”¯æŒ Weston12/Sway/Mutterï¼‰
# ğŸ”§ ä¿®å¤ï¼šWeston 12 ä½¿ç”¨ wayland-1ï¼ŒSway ä½¿ç”¨ wayland-0
Environment="WAYLAND_DISPLAY=wayland-1"
Environment="WAYLAND_DEBUG=0"
Environment="EGL_PLATFORM=wayland"
Environment="QT_QPA_PLATFORM=wayland"
Environment="GDK_BACKEND=wayland"
Environment="SDL_VIDEODRIVER=wayland"
Environment="XDG_SESSION_TYPE=wayland"
Environment="LIBINPUT_DEFAULT_TOUCH_ENABLED=1"

# è®¾å¤‡æƒé™ç»„
SupplementaryGroups=input video render tty dialout

# èµ„æºé™åˆ¶
LimitNOFILE=65536
LimitNPROC=4096
OOMScoreAdjust=-100

# å¯åŠ¨å‰æ£€æŸ¥å’Œæ¸…ç†
ExecStartPre=/bin/bash -c 'systemctl is-active --quiet bamboo-cpp-lvgl.service && systemctl stop bamboo-cpp-lvgl.service || true'
ExecStartPre=/bin/bash -c 'pkill -9 bamboo_integrated || true'
ExecStartPre=/bin/bash -c 'pkill -9 bamboo_cu || true'
ExecStartPre=/bin/bash -c 'for p in $(lsof -t /dev/video0 2>/dev/null); do kill -9 $p; done || true'
ExecStartPre=/bin/bash -c 'for p in $(lsof -t /dev/video1 2>/dev/null); do kill -9 $p; done || true'
ExecStartPre=/bin/bash -c 'systemctl restart nvargus-daemon'
# æ£€æŸ¥å¹¶å¯åŠ¨ Wayland åˆæˆå™¨ï¼ˆä¼˜å…ˆçº§: Weston12 > Sway > Mutterï¼‰
ExecStartPre=/bin/bash -c 'if systemctl list-unit-files | grep -q weston12.service; then systemctl is-active --quiet weston12.service || systemctl start weston12.service; elif systemctl list-unit-files | grep -q sway-wayland.service; then systemctl is-active --quiet sway-wayland.service || systemctl start sway-wayland.service; elif systemctl list-unit-files | grep -q mutter-wayland.service; then systemctl is-active --quiet mutter-wayland.service || systemctl start mutter-wayland.service; elif systemctl list-unit-files | grep -q weston.service; then systemctl is-active --quiet weston.service || systemctl start weston.service; fi'
ExecStartPre=/bin/bash -c 'if [ ! -S /run/user/0/wayland-0 ] && [ ! -S /run/user/0/wayland-1 ]; then echo "å¯åŠ¨ Wayland åˆæˆå™¨..."; if systemctl list-unit-files | grep -q weston12.service; then systemctl start weston12.service 2>/dev/null || true; elif [ -f /usr/bin/sway ]; then systemctl start sway-wayland.service 2>/dev/null || true; elif [ -f /usr/bin/mutter ]; then systemctl start mutter-wayland.service 2>/dev/null || true; elif [ -f /usr/bin/weston ]; then systemctl start weston.service 2>/dev/null || true; fi; sleep 3; fi'
ExecStartPre=/bin/bash -c 'timeout 30 bash -c "while [ ! -S /run/user/0/wayland-0 ] && [ ! -S /run/user/0/wayland-1 ]; do sleep 1; done" || echo "Wayland socket ä¸å¯ç”¨ï¼Œç»§ç»­ä½¿ç”¨ fallback æ¨¡å¼"'
ExecStartPre=/bin/sleep 3

# æ”¹è¿›åœæ­¢å‘½ä»¤
ExecStop=/bin/bash -c 'kill -TERM $MAINPID; sleep 2; pkill -9 -g $MAINPID bamboo_integrated || true'

# æ›´æ¿€è¿›çš„æ¸…ç†
TimeoutStopSec=10
KillMode=control-group
SendSIGKILL=yes
# é‡å¯ç­–ç•¥
Restart=always
RestartSec=15
TimeoutStartSec=120
TimeoutStopSec=60
KillMode=mixed

# å®‰å…¨è®¾ç½®ï¼ˆå…è®¸è®¿é—®ç¡¬ä»¶è®¾å¤‡ï¼‰
NoNewPrivileges=false
PrivateTmp=false
ProtectSystem=false
ProtectHome=false

# æ—¥å¿—è¾“å‡º
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target