# ä¸€ä½“åŒ–ç«¹å­è¯†åˆ«ç³»ç»Ÿ CMakeé…ç½®
# ç‰ˆæœ¬: 3.0.0 (Integrated Architecture)
# æ•´åˆcpp_backendå’Œlvgl_frontendä¸ºå•ä¸€é«˜æ€§èƒ½è¿›ç¨‹

cmake_minimum_required(VERSION 3.16)
project(BambooIntegratedSystem VERSION 3.0.0 LANGUAGES C CXX)

# C++æ ‡å‡†è®¾ç½®
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_C_STANDARD 11)
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)

# è®¾ç½®æ„å»ºç±»å‹
if(NOT CMAKE_BUILD_TYPE)
    set(CMAKE_BUILD_TYPE Release)
endif()

# å¯ç”¨ FetchContent ç”¨äºè‡ªåŠ¨ä¸‹è½½ä¾èµ–
include(FetchContent)

# ç¼–è¯‘é€‰é¡¹ - æ•´åˆä¸¤ä¸ªé¡¹ç›®çš„ä¼˜åŒ–é€‰é¡¹
set(CMAKE_C_FLAGS_DEBUG "-g -O0 -Wall -Wextra")
set(CMAKE_CXX_FLAGS_DEBUG "-g -O0 -Wall -Wextra")
set(CMAKE_C_FLAGS_RELEASE "-O3 -ffast-math -DNDEBUG")
set(CMAKE_CXX_FLAGS_RELEASE "-O3 -ffast-math -DNDEBUG")

# æ£€æµ‹ç›®æ ‡å¹³å°
if(CMAKE_SYSTEM_PROCESSOR MATCHES "aarch64|arm64")
    set(TARGET_ARCH "aarch64")
    message(STATUS "Target architecture: ARM64/AArch64 (Jetson)")
    add_compile_definitions(JETSON_PLATFORM)
    set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -mcpu=cortex-a78")
    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -mcpu=cortex-a78")
elseif(CMAKE_SYSTEM_PROCESSOR MATCHES "x86_64|AMD64")
    set(TARGET_ARCH "x86_64")
    message(STATUS "Target architecture: x86_64")
else()
    message(FATAL_ERROR "Unsupported architecture: ${CMAKE_SYSTEM_PROCESSOR}")
endif()

# ================================
# æŸ¥æ‰¾ä¾èµ–åº“
# ================================
option(ENABLE_WAYLAND "Enable Wayland client/compositor support" OFF)

# æŸ¥æ‰¾PkgConfig
find_package(PkgConfig REQUIRED)
find_package(Threads REQUIRED)

# OpenCV - å¤šç§æ–¹å¼æŸ¥æ‰¾ä»¥æé«˜å…¼å®¹æ€§
set(ENABLE_OPENCV OFF)
set(OpenCV_FOUND FALSE)

# ä¼˜å…ˆä½¿ç”¨find_packageæŸ¥æ‰¾OpenCV
find_package(OpenCV QUIET)
if(OpenCV_FOUND)
    message(STATUS "Found OpenCV via find_package: ${OpenCV_VERSION}")
    set(ENABLE_OPENCV ON)
else()
    # å›é€€åˆ°pkg-configæŸ¥æ‰¾
    if(PkgConfig_FOUND)
        pkg_check_modules(OPENCV QUIET opencv4)
        if(NOT OPENCV_FOUND)
            pkg_check_modules(OPENCV QUIET opencv)
        endif()
        
        if(OPENCV_FOUND)
            message(STATUS "Found OpenCV via pkg-config: ${OPENCV_VERSION}")
            set(ENABLE_OPENCV ON)
            set(OpenCV_FOUND TRUE)
            set(OpenCV_LIBS ${OPENCV_LIBRARIES})
            set(OpenCV_INCLUDE_DIRS ${OPENCV_INCLUDE_DIRS})
            include_directories(${OPENCV_INCLUDE_DIRS})
            link_directories(${OPENCV_LIBRARY_DIRS})
        endif()
    endif()
endif()

if(NOT ENABLE_OPENCV)
    # æ‰‹åŠ¨æŸ¥æ‰¾OpenCV (Jetsonç‰¹å®šè·¯å¾„)
    set(OPENCV_SEARCH_PATHS
        /usr/include/opencv4
        /usr/local/include/opencv4
        /opt/opencv/include/opencv4
        /usr/include/opencv2
        /usr/local/include/opencv2
        /usr/include
        /usr/local/include
    )
    
    find_path(OpenCV_INCLUDE_DIR opencv2/opencv.hpp PATHS ${OPENCV_SEARCH_PATHS})
    if(OpenCV_INCLUDE_DIR)
        find_library(OpenCV_CORE_LIB opencv_core
            PATHS /usr/lib /usr/local/lib /usr/lib/aarch64-linux-gnu /usr/lib/x86_64-linux-gnu)
        
        if(OpenCV_CORE_LIB)
            message(STATUS "Found OpenCV manually: ${OpenCV_INCLUDE_DIR}")
            set(ENABLE_OPENCV ON)
            set(OpenCV_FOUND TRUE)
            set(OpenCV_INCLUDE_DIRS ${OpenCV_INCLUDE_DIR})
            
            # æŸ¥æ‰¾å¸¸ç”¨çš„OpenCVåº“
            set(OpenCV_LIBS "")
            foreach(lib IN ITEMS opencv_core opencv_imgproc opencv_imgcodecs opencv_videoio opencv_video opencv_calib3d opencv_features2d opencv_objdetect opencv_dnn opencv_highgui)
                find_library(${lib}_LIB ${lib}
                    PATHS /usr/lib /usr/local/lib /usr/lib/aarch64-linux-gnu /usr/lib/x86_64-linux-gnu)
                if(${lib}_LIB)
                    list(APPEND OpenCV_LIBS ${${lib}_LIB})
                endif()
            endforeach()
            
            include_directories(${OpenCV_INCLUDE_DIRS})
        endif()
    endif()
endif()

if(NOT ENABLE_OPENCV)
    message(FATAL_ERROR "OpenCV not found! Please install OpenCV")
endif()

# GStreamer - æ•´åˆä¸¤ä¸ªé¡¹ç›®çš„GStreameré…ç½®
pkg_check_modules(GSTREAMER REQUIRED gstreamer-1.0)
pkg_check_modules(GSTREAMER_APP REQUIRED gstreamer-app-1.0)
pkg_check_modules(GSTREAMER_VIDEO REQUIRED gstreamer-video-1.0)
message(STATUS "Found GStreamer: ${GSTREAMER_VERSION}")
set(ENABLE_GSTREAMER ON)

# CUDA - Jetson Orin NXç‰¹æ®Šé…ç½®
if(TARGET_ARCH STREQUAL "aarch64")
    message(STATUS "Configuring CUDA for Jetson Orin NX...")
    
    # Jetson Orin NXçš„CUDAè·¯å¾„é…ç½®
    set(CUDA_TOOLKIT_ROOT_DIR "/usr/local/cuda")
    set(CMAKE_CUDA_COMPILER "/usr/local/cuda/bin/nvcc")
    
    # æŸ¥æ‰¾CUDAå¤´æ–‡ä»¶ - ç”¨æˆ·ç¯å¢ƒæœ‰cuda, cuda-12, cuda-12.6ä¸‰ä¸ªç‰ˆæœ¬
    find_path(CUDA_RUNTIME_INCLUDE cuda_runtime.h
        PATHS
            "/usr/local/cuda/include"
            "/usr/local/cuda-12.6/include"
            "/usr/local/cuda-12/include"
        NO_DEFAULT_PATH)
    
    # æŸ¥æ‰¾CUDAåº“
    find_library(CUDA_RUNTIME_LIBRARY cudart
        PATHS
            "/usr/local/cuda/lib64"
            "/usr/local/cuda-12.6/targets/aarch64-linux/lib"
            "/usr/local/cuda/targets/aarch64-linux/lib"
            "/usr/lib/aarch64-linux-gnu"
        NO_DEFAULT_PATH)
    
    if(CUDA_RUNTIME_INCLUDE AND CUDA_RUNTIME_LIBRARY)
        message(STATUS "Found CUDA for Jetson: ${CUDA_RUNTIME_LIBRARY}")
        set(ENABLE_CUDA ON)
        set(CUDA_FOUND TRUE)
        
        # å¯ç”¨CUDAè¯­è¨€æ”¯æŒ
        enable_language(CUDA)
        
        # è®¾ç½®CUDAåŒ…å«ç›®å½•
        include_directories(${CUDA_RUNTIME_INCLUDE})
        
        # æ·»åŠ CUDAåº“ç›®å½•åˆ°é“¾æ¥å™¨æœç´¢è·¯å¾„
        link_directories(${CUDA_LIB_PATHS})
        
        # è®¾ç½®CUDAç¼–è¯‘å™¨æ ‡å¿—
        set(CMAKE_CUDA_FLAGS "${CMAKE_CUDA_FLAGS} -arch=sm_87")  # Orin NX GPUæ¶æ„
        set(CMAKE_CUDA_FLAGS_RELEASE "${CMAKE_CUDA_FLAGS_RELEASE} -O3")
        
        # æŸ¥æ‰¾å…¶ä»–CUDAåº“ - é€‚é…ç”¨æˆ·çš„å¤šCUDAç‰ˆæœ¬ç¯å¢ƒ
        set(CUDA_LIB_PATHS
            "/usr/local/cuda-12.6/targets/aarch64-linux/lib"
            "/usr/local/cuda-12/targets/aarch64-linux/lib"
            "/usr/local/cuda/targets/aarch64-linux/lib"
            "/usr/local/cuda-12.6/lib64"
            "/usr/local/cuda-12/lib64"
            "/usr/local/cuda/lib64"
            "/usr/lib/aarch64-linux-gnu"
        )
        
        find_library(CUBLAS_LIBRARY cublas PATHS ${CUDA_LIB_PATHS} NO_DEFAULT_PATH)
        find_library(CURAND_LIBRARY curand PATHS ${CUDA_LIB_PATHS} NO_DEFAULT_PATH)
        find_library(CUFFT_LIBRARY cufft PATHS ${CUDA_LIB_PATHS} NO_DEFAULT_PATH)
        
        set(CUDA_LIBRARIES ${CUDA_RUNTIME_LIBRARY})
        if(CUBLAS_LIBRARY)
            list(APPEND CUDA_LIBRARIES ${CUBLAS_LIBRARY})
        endif()
        if(CURAND_LIBRARY)
            list(APPEND CUDA_LIBRARIES ${CURAND_LIBRARY})
        endif()
        if(CUFFT_LIBRARY)
            list(APPEND CUDA_LIBRARIES ${CUFFT_LIBRARY})
        endif()
        
        message(STATUS "Jetson CUDA libraries: ${CUDA_LIBRARIES}")
        
    else()
        message(FATAL_ERROR "CUDA not found on Jetson Orin NX. Please ensure CUDA is properly installed.")
    endif()
    
else()
    # x86_64å¹³å°çš„æ ‡å‡†CUDAæŸ¥æ‰¾
    find_package(CUDA QUIET)
    if(CUDA_FOUND)
        find_path(CUDA_RUNTIME_INCLUDE cuda_runtime.h
            PATHS ${CUDA_TOOLKIT_ROOT_DIR}/include /usr/local/cuda/include)
        
        if(CUDA_RUNTIME_INCLUDE)
            message(STATUS "Found CUDA: ${CUDA_VERSION}")
            set(ENABLE_CUDA ON)
            enable_language(CUDA)
            include_directories(${CUDA_INCLUDE_DIRS})
        else()
            message(WARNING "CUDA headers not found - GPUåŠŸèƒ½å°†è¢«ç¦ç”¨")
            set(ENABLE_CUDA OFF)
        endif()
    else()
        message(WARNING "CUDA not found - GPUåŠŸèƒ½å°†è¢«ç¦ç”¨")
        set(ENABLE_CUDA OFF)
    endif()
endif()

# TensorRT - Jetson Orin NXç‰¹æ®Šé…ç½®
if(ENABLE_CUDA)
    if(TARGET_ARCH STREQUAL "aarch64")
        message(STATUS "Configuring TensorRT for Jetson Orin NX...")
        
        # Jetson Orin NXçš„TensorRTè·¯å¾„
        set(TENSORRT_SEARCH_PATHS
            "/usr/include/aarch64-linux-gnu"
            "/usr/include"
            "/usr/local/include"
            "/opt/nvidia/vpi2/include"
        )
        
        set(TENSORRT_LIB_PATHS
            "/usr/lib/aarch64-linux-gnu"
            "/usr/local/lib"
            "/opt/nvidia/vpi2/lib64"
        )
        
        # æŸ¥æ‰¾TensorRTå¤´æ–‡ä»¶
        find_path(TENSORRT_INCLUDE_DIR NvInfer.h
            PATHS ${TENSORRT_SEARCH_PATHS}
            NO_DEFAULT_PATH)
        
        # æŸ¥æ‰¾TensorRTåº“
        find_library(TENSORRT_INFER_LIBRARY nvinfer
            PATHS ${TENSORRT_LIB_PATHS}
            NO_DEFAULT_PATH)
        
        find_library(TENSORRT_ONNX_LIBRARY nvonnxparser
            PATHS ${TENSORRT_LIB_PATHS}
            NO_DEFAULT_PATH)
        
        find_library(TENSORRT_PLUGIN_LIBRARY nvinfer_plugin
            PATHS ${TENSORRT_LIB_PATHS}
            NO_DEFAULT_PATH)
        
        if(TENSORRT_INCLUDE_DIR AND TENSORRT_INFER_LIBRARY)
            set(TENSORRT_FOUND ON)
            set(ENABLE_TENSORRT ON)
            set(ENABLE_FP16 ON)  # Jetsonæ”¯æŒFP16
            
            message(STATUS "Found TensorRT for Jetson:")
            message(STATUS "  Include: ${TENSORRT_INCLUDE_DIR}")
            message(STATUS "  nvinfer: ${TENSORRT_INFER_LIBRARY}")
            
            set(TENSORRT_LIBRARIES ${TENSORRT_INFER_LIBRARY})
            if(TENSORRT_ONNX_LIBRARY)
                list(APPEND TENSORRT_LIBRARIES ${TENSORRT_ONNX_LIBRARY})
                message(STATUS "  nvonnxparser: ${TENSORRT_ONNX_LIBRARY}")
            endif()
            if(TENSORRT_PLUGIN_LIBRARY)
                list(APPEND TENSORRT_LIBRARIES ${TENSORRT_PLUGIN_LIBRARY})
                message(STATUS "  nvinfer_plugin: ${TENSORRT_PLUGIN_LIBRARY}")
            endif()
            
            include_directories(${TENSORRT_INCLUDE_DIR})
            
        else()
            message(FATAL_ERROR "TensorRT not found on Jetson Orin NX. Please ensure TensorRT is properly installed.")
        endif()
        
    else()
        # x86_64å¹³å°çš„æ ‡å‡†TensorRTæŸ¥æ‰¾
        find_path(TENSORRT_INCLUDE_DIR NvInfer.h
            HINTS ${TENSORRT_ROOT} ${CUDA_TOOLKIT_ROOT_DIR}
            PATH_SUFFIXES include
            PATHS /usr/include/x86_64-linux-gnu /usr/include)
        
        find_library(TENSORRT_INFER_LIBRARY nvinfer
            HINTS ${TENSORRT_ROOT} ${CUDA_TOOLKIT_ROOT_DIR}
            PATH_SUFFIXES lib lib64
            PATHS /usr/lib/x86_64-linux-gnu /usr/lib)
        
        find_library(TENSORRT_ONNX_LIBRARY nvonnxparser
            HINTS ${TENSORRT_ROOT} ${CUDA_TOOLKIT_ROOT_DIR}
            PATH_SUFFIXES lib lib64
            PATHS /usr/lib/x86_64-linux-gnu /usr/lib)
        
        if(TENSORRT_INCLUDE_DIR AND TENSORRT_INFER_LIBRARY)
            set(TENSORRT_FOUND ON)
            set(ENABLE_TENSORRT ON)
            message(STATUS "Found TensorRT: ${TENSORRT_INFER_LIBRARY}")
            set(TENSORRT_LIBRARIES ${TENSORRT_INFER_LIBRARY})
            if(TENSORRT_ONNX_LIBRARY)
                list(APPEND TENSORRT_LIBRARIES ${TENSORRT_ONNX_LIBRARY})
            endif()
            include_directories(${TENSORRT_INCLUDE_DIR})
        else()
            message(WARNING "TensorRT not found - ä½¿ç”¨OpenCV DNNåå¤‡")
            set(ENABLE_TENSORRT OFF)
        endif()
    endif()
else()
    set(ENABLE_TENSORRT OFF)
endif()

# libmodbus - å¯é€‰ä¾èµ–
find_library(MODBUS_LIBRARY modbus
    PATHS /usr/lib /usr/local/lib /usr/lib/aarch64-linux-gnu /usr/lib/x86_64-linux-gnu)
find_path(MODBUS_INCLUDE_DIR modbus/modbus.h
    PATHS /usr/include /usr/local/include)

if(MODBUS_LIBRARY AND MODBUS_INCLUDE_DIR)
    message(STATUS "Found libmodbus: ${MODBUS_LIBRARY}")
    set(ENABLE_MODBUS ON)
    include_directories(${MODBUS_INCLUDE_DIR})
else()
    message(WARNING "libmodbus not found - PLCé€šä¿¡åŠŸèƒ½å°†è¢«ç¦ç”¨")
    set(ENABLE_MODBUS OFF)
endif()

# nlohmann/json - å¯é€‰ä¾èµ–
find_package(nlohmann_json QUIET)
if(nlohmann_json_FOUND)
    message(STATUS "Found nlohmann_json: ${nlohmann_json_VERSION}")
    set(ENABLE_JSON ON)
else()
    message(WARNING "nlohmann_json not found - JSONåŠŸèƒ½å°†è¢«ç¦ç”¨")
    set(ENABLE_JSON OFF)
endif()

# Wayland - æ ‡å‡†Wayland Compositoræ¶æ„ (å¯é€‰ï¼Œé»˜è®¤å…³é—­ä»¥æ”¯æŒæ— åˆæˆå™¨)
if(ENABLE_WAYLAND)
    pkg_check_modules(WAYLAND_CLIENT QUIET wayland-client)
    pkg_check_modules(WAYLAND_EGL QUIET wayland-egl)
    pkg_check_modules(WAYLAND_PROTOCOLS QUIET wayland-protocols)

    if(WAYLAND_CLIENT_FOUND AND WAYLAND_EGL_FOUND)
        message(STATUS "Found Wayland client: ${WAYLAND_CLIENT_VERSION}")
        message(STATUS "Found Wayland EGL: ${WAYLAND_EGL_VERSION}")
        include_directories(${WAYLAND_CLIENT_INCLUDE_DIRS} ${WAYLAND_EGL_INCLUDE_DIRS})
        link_directories(${WAYLAND_CLIENT_LIBRARY_DIRS} ${WAYLAND_EGL_LIBRARY_DIRS})
        
        if(WAYLAND_PROTOCOLS_FOUND)
            message(STATUS "Found Wayland protocols: ${WAYLAND_PROTOCOLS_VERSION}")
        endif()
    else()
        message(WARNING "Wayland client libraries not found - Wayland support disabled")
        set(ENABLE_WAYLAND OFF)
    endif()
endif()

# æŸ¥æ‰¾EGLåº“ (Waylandéœ€è¦EGLæ”¯æŒ)
find_library(EGL_LIBRARY EGL
    PATHS /usr/lib /usr/local/lib /usr/lib/aarch64-linux-gnu /usr/lib/x86_64-linux-gnu)
find_path(EGL_INCLUDE_DIR EGL/egl.h
    PATHS /usr/include /usr/local/include)

if(EGL_LIBRARY AND EGL_INCLUDE_DIR)
    message(STATUS "Found EGL: ${EGL_LIBRARY}")
    set(ENABLE_EGL ON)
    set(EGL_LIBRARIES ${EGL_LIBRARY})
    include_directories(${EGL_INCLUDE_DIR})
else()
    message(FATAL_ERROR "EGL not found - Waylandéœ€è¦EGLæ”¯æŒ")
endif()

# æŸ¥æ‰¾GBMåº“ (DRM EGLåç«¯éœ€è¦)
find_library(GBM_LIBRARY gbm
    PATHS /usr/lib /usr/local/lib /usr/lib/aarch64-linux-gnu /usr/lib/x86_64-linux-gnu)
find_path(GBM_INCLUDE_DIR gbm.h
    PATHS /usr/include /usr/local/include)

if(GBM_LIBRARY AND GBM_INCLUDE_DIR)
    message(STATUS "Found GBM: ${GBM_LIBRARY}")
    set(ENABLE_GBM ON)
    set(GBM_LIBRARIES ${GBM_LIBRARY})
    include_directories(${GBM_INCLUDE_DIR})
    list(APPEND EGL_LIBRARIES ${GBM_LIBRARY})
else()
    message(FATAL_ERROR "GBM not found - DRM EGLåç«¯éœ€è¦GBMæ”¯æŒ")
endif()

# æŸ¥æ‰¾OpenGL ESåº“ (DRM EGLæ¸²æŸ“éœ€è¦)
find_library(GLES2_LIBRARY GLESv2
    PATHS /usr/lib /usr/local/lib /usr/lib/aarch64-linux-gnu /usr/lib/x86_64-linux-gnu)
find_path(GLES2_INCLUDE_DIR GLES2/gl2.h
    PATHS /usr/include /usr/local/include)

if(GLES2_LIBRARY AND GLES2_INCLUDE_DIR)
    message(STATUS "Found OpenGL ES: ${GLES2_LIBRARY}")
    set(ENABLE_GLES2 ON)
    set(GLES2_LIBRARIES ${GLES2_LIBRARY})
    include_directories(${GLES2_INCLUDE_DIR})
    list(APPEND EGL_LIBRARIES ${GLES2_LIBRARY})
else()
    message(FATAL_ERROR "OpenGL ES not found - DRM EGLæ¸²æŸ“éœ€è¦OpenGL ESæ”¯æŒ")
endif()

# æŸ¥æ‰¾DRMåº“ (DRMç›´æ¥è®¿é—®éœ€è¦)
find_library(DRM_LIBRARY drm
    PATHS /usr/lib /usr/local/lib /usr/lib/aarch64-linux-gnu /usr/lib/x86_64-linux-gnu)
find_path(DRM_INCLUDE_DIR libdrm/drm.h
    PATHS /usr/include /usr/local/include)

if(DRM_LIBRARY AND DRM_INCLUDE_DIR)
    message(STATUS "Found DRM: ${DRM_LIBRARY}")
    message(STATUS "DRM include dir: ${DRM_INCLUDE_DIR}")
    set(ENABLE_DRM_LIB ON)
    set(DRM_LIBRARIES ${DRM_LIBRARY})
    include_directories(${DRM_INCLUDE_DIR})
    include_directories(${DRM_INCLUDE_DIR}/libdrm)
    list(APPEND EGL_LIBRARIES ${DRM_LIBRARY})
else()
    message(FATAL_ERROR "DRM library not found - DRM EGLåç«¯éœ€è¦libdrmæ”¯æŒ")
endif()

# xkbcommon - Waylandé”®ç›˜è¾“å…¥æ”¯æŒ
pkg_check_modules(XKBCOMMON QUIET xkbcommon)
if(XKBCOMMON_FOUND)
    message(STATUS "Found xkbcommon: ${XKBCOMMON_VERSION}")
    set(ENABLE_XKBCOMMON ON)
    include_directories(${XKBCOMMON_INCLUDE_DIRS})
    link_directories(${XKBCOMMON_LIBRARY_DIRS})
else()
    message(WARNING "xkbcommon not found - é”®ç›˜è¾“å…¥å¯èƒ½å—é™")
    set(ENABLE_XKBCOMMON OFF)
endif()

# å¯ç”¨DRM EGLå…±äº«æ¶æ„ï¼ˆæ›¿ä»£DRMç›´æ¥è®¿é—®ï¼‰
set(ENABLE_DRM OFF)  # ç¦ç”¨æ—§çš„DRMç›´æ¥è®¿é—®
set(ENABLE_NVIDIA_DRM OFF)
set(ENABLE_TEGRA_DRM OFF)
# ENABLE_GBM, ENABLE_GLES2, ENABLE_DRM_LIB åœ¨ä¸Šé¢å·²è®¾ç½®
message(STATUS "DRMç›´æ¥è®¿é—®å·²ç¦ç”¨ - ä½¿ç”¨DRM EGLå…±äº«æ¶æ„")

# ç§»é™¤Pythonç»‘å®šç›¸å…³é…ç½® - é¡¹ç›®ç°åœ¨æ˜¯çº¯C++æ¶æ„
set(ENABLE_PYBIND11 OFF)
set(ENABLE_PYTHON OFF)
message(STATUS "Pythonç»‘å®šå·²ç¦ç”¨ - ä½¿ç”¨çº¯C++ä¸€ä½“åŒ–æ¶æ„")

# ================================
# LVGLé…ç½® - ä½¿ç”¨ç³»ç»Ÿå®‰è£…çš„LVGL
# ================================

# æŸ¥æ‰¾ç³»ç»Ÿå®‰è£…çš„LVGL - ä¼˜å…ˆä½¿ç”¨pkg-config
pkg_check_modules(LVGL QUIET lvgl)
if(LVGL_FOUND)
    message(STATUS "Found LVGL via pkg-config: ${LVGL_VERSION}")
    set(ENABLE_LVGL ON)
    include_directories(${LVGL_INCLUDE_DIRS})
    link_directories(${LVGL_LIBRARY_DIRS})
    
    # åˆ›å»ºå¯¼å…¥çš„ç›®æ ‡ - ä¿®å¤è·¯å¾„éªŒè¯
    if(EXISTS "${LVGL_INCLUDE_DIRS}")
        add_library(lvgl SHARED IMPORTED)
        set_target_properties(lvgl PROPERTIES
            IMPORTED_LOCATION "${LVGL_LIBRARY_DIRS}/liblvgl.so"
            INTERFACE_INCLUDE_DIRECTORIES "${LVGL_INCLUDE_DIRS}"
        )
    else()
        message(WARNING "LVGL include directory does not exist: ${LVGL_INCLUDE_DIRS}")
        # å°è¯•ç®€å•çš„åŒ…å«ç›®å½•è®¾ç½®
        include_directories(${LVGL_INCLUDE_DIRS})
    endif()
else()
    # å›é€€åˆ°find_package
    find_package(lvgl QUIET)
    if(lvgl_FOUND)
        message(STATUS "Found system LVGL package: ${lvgl_VERSION}")
        set(ENABLE_LVGL ON)
    else()
        # æ‰‹åŠ¨æŸ¥æ‰¾ç³»ç»Ÿå®‰è£…çš„LVGL
        find_path(LVGL_INCLUDE_DIR lvgl/lvgl.h
            PATHS
                /usr/local/include
                /usr/include
                /opt/lvgl/include
            NO_DEFAULT_PATH)
        
        find_library(LVGL_LIBRARY lvgl
            PATHS
                /usr/local/lib
                /usr/lib
                /usr/lib/aarch64-linux-gnu
                /usr/lib/x86_64-linux-gnu
                /opt/lvgl/lib
            NO_DEFAULT_PATH)
        
        if(LVGL_INCLUDE_DIR AND LVGL_LIBRARY)
            message(STATUS "Found system LVGL manually:")
            message(STATUS "  Include: ${LVGL_INCLUDE_DIR}")
            message(STATUS "  Library: ${LVGL_LIBRARY}")
            set(ENABLE_LVGL ON)
            set(LVGL_FOUND TRUE)
            
            # åˆ›å»ºå¯¼å…¥çš„ç›®æ ‡
            add_library(lvgl SHARED IMPORTED)
            set_target_properties(lvgl PROPERTIES
                IMPORTED_LOCATION ${LVGL_LIBRARY}
                INTERFACE_INCLUDE_DIRECTORIES ${LVGL_INCLUDE_DIR}
            )
            
            include_directories(${LVGL_INCLUDE_DIR})
        else()
            message(WARNING "System LVGL not found - LVGLåŠŸèƒ½å°†è¢«ç¦ç”¨")
            set(ENABLE_LVGL OFF)
            set(LVGL_FOUND FALSE)
        endif()
    endif()
endif()

# è®¾ç½®LVGLé…ç½®æ–‡ä»¶è·¯å¾„
if(ENABLE_LVGL)
    set(LV_CONF_PATH ${CMAKE_CURRENT_SOURCE_DIR}/lv_conf.h CACHE STRING "Path to lv_conf.h")
    message(STATUS "Using lv_conf.h from: ${LV_CONF_PATH}")
endif()

# ================================
# åŒ…å«ç›®å½•
# ================================
include_directories(
    ${CMAKE_CURRENT_SOURCE_DIR}
    ${CMAKE_CURRENT_SOURCE_DIR}/cpp_backend/include
    ${CMAKE_CURRENT_SOURCE_DIR}/lvgl_frontend/include
    ${CMAKE_CURRENT_SOURCE_DIR}/cpp_inference
    ${CMAKE_CURRENT_BINARY_DIR}/third_party/lvgl
    ${OpenCV_INCLUDE_DIRS}
    ${GSTREAMER_INCLUDE_DIRS}
    ${GSTREAMER_APP_INCLUDE_DIRS}
    ${GSTREAMER_VIDEO_INCLUDE_DIRS}
)

if(ENABLE_CUDA)
    include_directories(${CUDA_INCLUDE_DIRS})
endif()


# ================================
# æºæ–‡ä»¶æ”¶é›†
# ================================

# C++åç«¯æºæ–‡ä»¶ - Waylandè¿ç§»åçš„ç²¾ç¡®é…ç½®
# ç§»é™¤æ‰€æœ‰DRMç›¸å…³æºæ–‡ä»¶ï¼Œæ·»åŠ Waylandæ¥å£
set(CPP_BACKEND_SOURCES
    cpp_backend/src/utils/logger.cpp
    cpp_backend/src/core/system_utils.cpp
    cpp_backend/src/core/bamboo_system.cpp
    cpp_backend/src/core/data_bridge.cpp
    cpp_backend/src/vision/stereo_vision.cpp
    cpp_backend/src/vision/detector.cpp
    cpp_backend/src/vision/camera_manager.cpp
    cpp_backend/src/vision/shared_memory_manager.cpp
    cpp_backend/src/vision/optimized_detector.cpp
    cpp_backend/src/vision/nam_attention.cpp
    cpp_backend/src/vision/ghost_conv.cpp
    cpp_backend/src/vision/vov_gscsp.cpp
    cpp_backend/src/vision/sahi_slicing.cpp
    cpp_backend/src/vision/wise_iou.cpp
    cpp_backend/src/vision/tensorrt_engine.cpp
    cpp_backend/src/vision/deepstream_pipeline.cpp
    cpp_backend/src/communication/modbus_server.cpp
    cpp_backend/src/communication/tcp_socket_server.cpp
    cpp_backend/src/communication/modbus_interface.cpp
    cpp_backend/src/inference/bamboo_detector.cpp
    cpp_backend/src/inference/ghost_conv.cpp
    cpp_backend/src/deepstream/deepstream_manager.cpp
    cpp_backend/src/ui/lvgl_ui_utils.cpp
    cpp_backend/src/ui/ui_components.cpp
    cpp_backend/src/ui/ui_updaters.cpp
    # ğŸ”§ æ³¨æ„ï¼šä»¥ä¸‹ panel æ–‡ä»¶ä»…ç”¨äº DRM ç‰ˆæœ¬ï¼ˆLVGLInterfaceï¼‰
    # Wayland ç‰ˆæœ¬ï¼ˆLVGLWaylandInterfaceï¼‰ä½¿ç”¨å†…è”é¢æ¿åˆ›å»º
    # cpp_backend/src/ui/lvgl_panels/header_panel.cpp
    # cpp_backend/src/ui/lvgl_panels/camera_panel.cpp
    # cpp_backend/src/ui/lvgl_panels/control_panel.cpp
    # cpp_backend/src/ui/lvgl_panels/status_panel.cpp
    # cpp_backend/src/ui/lvgl_panels/footer_panel.cpp
    cpp_backend/src/utils/config_loader.cpp
    cpp_backend/src/utils/system_monitor.cpp
    cpp_backend/src/utils/jetson_monitor.cpp
    cpp_backend/src/ui/egl_context_manager.cpp
)

# é€‰æ‹©æ¥å£å®ç°ï¼šWayland æˆ– DRM
if(ENABLE_WAYLAND)
    list(APPEND CPP_BACKEND_SOURCES cpp_backend/src/ui/lvgl_wayland_interface.cpp)
else()
    list(APPEND CPP_BACKEND_SOURCES cpp_backend/src/ui/lvgl_drm_interface.cpp)
endif()


# ğŸ”§ ä¿®å¤ï¼šåœ¨æ„å»ºæ—¶ä»ç³»ç»Ÿ wayland-protocols ç”Ÿæˆ xdg-shell åè®®æ–‡ä»¶
if(ENABLE_WAYLAND)
    # æŸ¥æ‰¾ wayland-scanner
    find_program(WAYLAND_SCANNER wayland-scanner REQUIRED)

    # æŸ¥æ‰¾ç³»ç»Ÿçš„ xdg-shell.xml
    execute_process(
        COMMAND pkg-config --variable=pkgdatadir wayland-protocols
        OUTPUT_VARIABLE WAYLAND_PROTOCOLS_DIR
        OUTPUT_STRIP_TRAILING_WHITESPACE
    )

    set(XDG_SHELL_XML "${WAYLAND_PROTOCOLS_DIR}/stable/xdg-shell/xdg-shell.xml")

    if(NOT EXISTS "${XDG_SHELL_XML}")
        message(FATAL_ERROR "æ‰¾ä¸åˆ° xdg-shell.xml: ${XDG_SHELL_XML}")
    endif()

    message(STATUS "Found xdg-shell.xml: ${XDG_SHELL_XML}")

    # ç”Ÿæˆåè®®æ–‡ä»¶çš„è¾“å‡ºç›®å½•
    set(WAYLAND_PROTOCOLS_GEN_DIR "${CMAKE_CURRENT_BINARY_DIR}/wayland-protocols")
    file(MAKE_DIRECTORY ${WAYLAND_PROTOCOLS_GEN_DIR})

    # ç”Ÿæˆ xdg-shell å®¢æˆ·ç«¯å¤´æ–‡ä»¶
    set(XDG_SHELL_CLIENT_HEADER "${WAYLAND_PROTOCOLS_GEN_DIR}/xdg-shell-client-protocol.h")
    add_custom_command(
        OUTPUT ${XDG_SHELL_CLIENT_HEADER}
        COMMAND ${WAYLAND_SCANNER} client-header ${XDG_SHELL_XML} ${XDG_SHELL_CLIENT_HEADER}
        DEPENDS ${XDG_SHELL_XML}
        COMMENT "Generating xdg-shell client header"
        VERBATIM
    )

    # ç”Ÿæˆ xdg-shell åè®®å®ç°ä»£ç 
    set(XDG_SHELL_PROTOCOL_CODE "${WAYLAND_PROTOCOLS_GEN_DIR}/xdg-shell-protocol.c")
    add_custom_command(
        OUTPUT ${XDG_SHELL_PROTOCOL_CODE}
        COMMAND ${WAYLAND_SCANNER} private-code ${XDG_SHELL_XML} ${XDG_SHELL_PROTOCOL_CODE}
        DEPENDS ${XDG_SHELL_XML}
        COMMENT "Generating xdg-shell protocol code"
        VERBATIM
    )

    # åˆ›å»ºè‡ªå®šä¹‰ç›®æ ‡ç¡®ä¿åè®®æ–‡ä»¶åœ¨ç¼–è¯‘å‰ç”Ÿæˆ
    add_custom_target(generate_wayland_protocols
        DEPENDS ${XDG_SHELL_CLIENT_HEADER} ${XDG_SHELL_PROTOCOL_CODE}
    )

    # å°†ç”Ÿæˆçš„åè®®å®ç°æ·»åŠ åˆ°æºæ–‡ä»¶åˆ—è¡¨
    list(APPEND CPP_BACKEND_SOURCES ${XDG_SHELL_PROTOCOL_CODE})

    # æ·»åŠ ç”Ÿæˆæ–‡ä»¶çš„åŒ…å«ç›®å½•
    include_directories(${WAYLAND_PROTOCOLS_GEN_DIR})

    message(STATUS "Wayland protocols will be generated at build time")

    # æ·»åŠ lv_drivers Waylandæºæ–‡ä»¶ (å¦‚æœå­˜åœ¨)
    if(EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/third_party/lv_drivers")
        set(LV_DRIVERS_WAYLAND_SOURCES
            third_party/lv_drivers/wayland/wayland.c
            third_party/lv_drivers/indev/wayland_pointer.c
            third_party/lv_drivers/indev/wayland_pointeraxis.c
            third_party/lv_drivers/indev/wayland_keyboard.c
            third_party/lv_drivers/indev/wayland_touch.c
        )
        
        # è¿‡æ»¤å­˜åœ¨çš„lv_driversæºæ–‡ä»¶
        set(VALID_LV_DRIVERS_SOURCES)
        foreach(src ${LV_DRIVERS_WAYLAND_SOURCES})
            if(EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/${src})
                list(APPEND VALID_LV_DRIVERS_SOURCES ${src})
                message(STATUS "Found lv_drivers source: ${src}")
            endif()
        endforeach()
        
        if(VALID_LV_DRIVERS_SOURCES)
            list(APPEND CPP_BACKEND_SOURCES ${VALID_LV_DRIVERS_SOURCES})
            include_directories(${CMAKE_CURRENT_SOURCE_DIR}/third_party/lv_drivers)
            message(STATUS "Added lv_drivers Wayland sources: ${VALID_LV_DRIVERS_SOURCES}")
        endif()
    endif()
endif()

# æ¡ä»¶åŒ…å«CUDAç›¸å…³æ–‡ä»¶
if(ENABLE_CUDA)
    list(APPEND CPP_BACKEND_SOURCES
        cpp_backend/src/vision/hardware_accelerated_camera.cpp
    )
endif()

# æ’é™¤ä¸éœ€è¦çš„æºæ–‡ä»¶ - é¿å…ç¼–è¯‘é”™è¯¯
list(REMOVE_ITEM CPP_BACKEND_SOURCES
    "cpp_backend/src/ffi/flutter_interface.cpp"  # æ’é™¤Flutteræ¥å£
)

# LVGLå‰ç«¯æºæ–‡ä»¶ - åŸºäºåŸæœ‰CMakeLists.txtçš„ç²¾ç¡®é…ç½®
set(LVGL_FRONTEND_SOURCES
    # åº”ç”¨å±‚
    lvgl_frontend/src/app/main_app.cpp
    lvgl_frontend/src/app/event_manager.cpp
    lvgl_frontend/src/app/config_manager.cpp
    
    # ç³»ç»Ÿå±‚
    lvgl_frontend/src/system/lv_port_tick.c
    
    # æ˜¾ç¤ºç³»ç»Ÿ
    lvgl_frontend/src/display/framebuffer_driver.cpp
    lvgl_frontend/src/display/lvgl_display.cpp
    lvgl_frontend/src/display/gpu_accelerated.cpp
    
    # è¾“å…¥ç³»ç»Ÿ
    lvgl_frontend/src/input/touch_driver.cpp
    lvgl_frontend/src/input/input_calibration.cpp
    
    # æ‘„åƒå¤´ç³»ç»Ÿ
    lvgl_frontend/src/camera/v4l2_camera.cpp
    lvgl_frontend/src/camera/camera_manager.cpp
    lvgl_frontend/src/camera/shared_memory_reader.cpp
    lvgl_frontend/src/camera/gstreamer_receiver.cpp
    
    # åç«¯é€šä¿¡ç³»ç»Ÿ
    lvgl_frontend/src/backend/backend_client.cpp
    lvgl_frontend/src/backend/tcp_socket_client.cpp
    
    # AIæ¨ç†ç³»ç»Ÿ
    lvgl_frontend/src/ai/tensorrt_engine.cpp
    lvgl_frontend/src/ai/yolo_detector.cpp
    lvgl_frontend/src/ai/detection_processor.cpp
    
    # GUIç»„ä»¶
    lvgl_frontend/src/gui/video_view.cpp
    lvgl_frontend/src/gui/control_panel.cpp
    lvgl_frontend/src/gui/status_bar.cpp
    lvgl_frontend/src/gui/settings_page.cpp
)

# æ¡ä»¶åŒ…å«CUDAç›¸å…³æ–‡ä»¶
if(ENABLE_CUDA)
    list(APPEND LVGL_FRONTEND_SOURCES
        lvgl_frontend/src/camera/cuda_processor.cpp
    )
endif()

# C++æ¨ç†æ ¸å¿ƒæºæ–‡ä»¶ - æ¥è‡ªcpp_inferenceé¡¹ç›®
set(CPP_INFERENCE_SOURCES)
if(EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/cpp_inference/inference_core.cpp)
    set(CPP_INFERENCE_SOURCES
        cpp_inference/inference_core.cpp
        cpp_inference/utils.cpp
    )
    message(STATUS "Found cpp_inference components:")
    message(STATUS "  inference_core.cpp: ${CMAKE_CURRENT_SOURCE_DIR}/cpp_inference/inference_core.cpp")
    message(STATUS "  utils.cpp: ${CMAKE_CURRENT_SOURCE_DIR}/cpp_inference/utils.cpp")
    set(ENABLE_CPP_INFERENCE ON)
else()
    message(WARNING "cpp_inference components not found at: ${CMAKE_CURRENT_SOURCE_DIR}/cpp_inference/inference_core.cpp")
    set(ENABLE_CPP_INFERENCE OFF)
endif()

# è¿‡æ»¤ä¸å­˜åœ¨çš„æºæ–‡ä»¶
set(ALL_SOURCES ${CPP_BACKEND_SOURCES} ${LVGL_FRONTEND_SOURCES} ${CPP_INFERENCE_SOURCES})
set(VALID_SOURCES)
foreach(src ${ALL_SOURCES})
    # å¦‚æœæ˜¯ç»å¯¹è·¯å¾„ï¼ˆå¦‚ç”Ÿæˆçš„åè®®æ–‡ä»¶ï¼‰ï¼Œç›´æ¥æ·»åŠ 
    if(IS_ABSOLUTE ${src})
        list(APPEND VALID_SOURCES ${src})
        message(STATUS "Adding generated file: ${src}")
    elseif(EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/${src})
        list(APPEND VALID_SOURCES ${src})
    else()
        message(WARNING "Source file not found: ${src}")
    endif()
endforeach()

# ================================
# ä¸»ç¨‹åº - ä¸€ä½“åŒ–å¯æ‰§è¡Œæ–‡ä»¶
# ================================
add_executable(bamboo_integrated
    integrated_main.cpp
    ${VALID_SOURCES}
)

if(ENABLE_WAYLAND)
    # ç¡®ä¿åè®®æ–‡ä»¶åœ¨ç¼–è¯‘å‰ç”Ÿæˆ
    add_dependencies(bamboo_integrated generate_wayland_protocols)
endif()

# ç¡®ä¿åªæœ‰æˆ‘ä»¬çš„ä¸»ç¨‹åºæ˜¯é»˜è®¤æ„å»ºç›®æ ‡
set_property(DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR} PROPERTY VS_STARTUP_PROJECT bamboo_integrated)

# ç¼–è¯‘å®šä¹‰ - Waylandæ¶æ„
target_compile_definitions(bamboo_integrated PRIVATE
    INTEGRATED_BUILD=1
    LV_CONF_INCLUDE_SIMPLE=1
    $<$<BOOL:${ENABLE_WAYLAND}>:USE_WAYLAND=1>
    $<$<BOOL:${ENABLE_WAYLAND}>:LV_USE_WAYLAND=1>
    $<$<BOOL:${ENABLE_WAYLAND}>:ENABLE_WAYLAND=1>
    HAS_DRM_EGL_BACKEND=1
    $<$<BOOL:${ENABLE_CUDA}>:ENABLE_CUDA>
    $<$<BOOL:${ENABLE_TENSORRT}>:ENABLE_TENSORRT>
    $<$<BOOL:${ENABLE_MODBUS}>:ENABLE_MODBUS>
    $<$<BOOL:${ENABLE_JSON}>:ENABLE_JSON>
    $<$<BOOL:${ENABLE_OPENCV}>:ENABLE_OPENCV>
    $<$<BOOL:${ENABLE_GSTREAMER}>:ENABLE_GSTREAMER>
    $<$<BOOL:${ENABLE_LVGL}>:ENABLE_LVGL>
    $<$<BOOL:${ENABLE_CPP_INFERENCE}>:ENABLE_CPP_INFERENCE>
    $<$<BOOL:${ENABLE_WAYLAND}>:ENABLE_WAYLAND>
    $<$<BOOL:${ENABLE_EGL}>:ENABLE_EGL>
    $<$<BOOL:${ENABLE_GBM}>:ENABLE_GBM>
    $<$<BOOL:${ENABLE_GLES2}>:ENABLE_GLES2>
    $<$<BOOL:${ENABLE_DRM_LIB}>:ENABLE_DRM_LIB>
    $<$<BOOL:${ENABLE_XKBCOMMON}>:ENABLE_XKBCOMMON>
    $<$<STREQUAL:${TARGET_ARCH},aarch64>:JETSON_ORIN_NX>
)

if(CMAKE_BUILD_TYPE STREQUAL "Debug")
    target_compile_definitions(bamboo_integrated PRIVATE DEBUG=1)
endif()

# é“¾æ¥åº“
target_link_libraries(bamboo_integrated 
    ${OpenCV_LIBS}
    ${GSTREAMER_LIBRARIES}
    ${GSTREAMER_APP_LIBRARIES}
    ${GSTREAMER_VIDEO_LIBRARIES}
    Threads::Threads
    pthread
    dl
    m
)

# æ¡ä»¶é“¾æ¥åº“
if(ENABLE_CUDA)
    target_link_libraries(bamboo_integrated ${CUDA_LIBRARIES})
endif()

if(ENABLE_TENSORRT)
    target_link_libraries(bamboo_integrated ${TENSORRT_LIBRARIES})
endif()

if(ENABLE_MODBUS)
    target_link_libraries(bamboo_integrated ${MODBUS_LIBRARY})
endif()

if(ENABLE_JSON)
    target_link_libraries(bamboo_integrated nlohmann_json::nlohmann_json)
endif()

# Waylandåº“ - æ ‡å‡†Waylandå®¢æˆ·ç«¯æ¶æ„
if(ENABLE_WAYLAND)
    target_link_libraries(bamboo_integrated
        ${WAYLAND_CLIENT_LIBRARIES}
        ${WAYLAND_EGL_LIBRARIES}
    )
endif()

# EGLåº“ - Waylandéœ€è¦EGLæ”¯æŒ
if(ENABLE_EGL)
    target_link_libraries(bamboo_integrated ${EGL_LIBRARIES})
endif()

# xkbcommonåº“ - Waylandé”®ç›˜è¾“å…¥æ”¯æŒ
if(ENABLE_XKBCOMMON)
    target_link_libraries(bamboo_integrated ${XKBCOMMON_LIBRARIES})
endif()

# LVGLåº“ - ç¡®ä¿æ­£ç¡®é“¾æ¥
if(ENABLE_LVGL)
    if(TARGET lvgl)
        target_link_libraries(bamboo_integrated lvgl)
        message(STATUS "Linking LVGL library to bamboo_integrated")
    elseif(TARGET lvgl::lvgl)
        target_link_libraries(bamboo_integrated lvgl::lvgl)
        message(STATUS "Linking LVGL namespace library to bamboo_integrated")
    elseif(LVGL_FOUND AND LVGL_LIBRARIES)
        # ä½¿ç”¨pkg-configæ‰¾åˆ°çš„LVGLåº“
        target_link_libraries(bamboo_integrated ${LVGL_LIBRARIES})
        message(STATUS "Linking pkg-config LVGL libraries: ${LVGL_LIBRARIES}")
    else()
        # æŸ¥æ‰¾å·²å®‰è£…çš„LVGL
        find_package(lvgl QUIET)
        if(lvgl_FOUND)
            target_link_libraries(bamboo_integrated lvgl::lvgl)
            message(STATUS "Linking system LVGL library to bamboo_integrated")
        else()
            message(WARNING "LVGL library not found for linking")
            set(ENABLE_LVGL OFF)
        endif()
    endif()
else()
    message(WARNING "LVGL not available for linking")
endif()


# ================================
# æœåŠ¡æ–‡ä»¶é…ç½®å’Œå®‰è£…
# ================================

# é…ç½®systemdæœåŠ¡æ–‡ä»¶
if(EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/deploy/systemd/bamboo-cpp-lvgl.service.in")
    configure_file(
        "${CMAKE_CURRENT_SOURCE_DIR}/deploy/systemd/bamboo-cpp-lvgl.service.in"
        "${CMAKE_CURRENT_BINARY_DIR}/bamboo-cpp-lvgl.service"
        @ONLY
    )
    message(STATUS "Service file configured: ${CMAKE_CURRENT_BINARY_DIR}/bamboo-cpp-lvgl.service")
else()
    message(WARNING "Service template file not found: deploy/systemd/bamboo-cpp-lvgl.service.in")
endif()

# ================================
# å®‰è£…é…ç½®
# ================================
install(TARGETS bamboo_integrated
    RUNTIME DESTINATION bin
    COMPONENT Runtime
)

# å®‰è£…é…ç½®æ–‡ä»¶
if(EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/config")
    install(DIRECTORY config/
        DESTINATION share/bamboo/config
        COMPONENT Runtime
    )
endif()

# å®‰è£…æ¨¡å‹æ–‡ä»¶
if(EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/models")
    install(DIRECTORY models/
        DESTINATION share/bamboo/models
        COMPONENT Runtime
    )
endif()

# å®‰è£…systemdæœåŠ¡æ–‡ä»¶
if(EXISTS "${CMAKE_CURRENT_BINARY_DIR}/bamboo-cpp-lvgl.service")
    install(FILES "${CMAKE_CURRENT_BINARY_DIR}/bamboo-cpp-lvgl.service"
        DESTINATION /etc/systemd/system
        COMPONENT Runtime
    )
endif()

# ================================
# æ„å»ºä¿¡æ¯æ˜¾ç¤º
# ================================
message(STATUS "")
message(STATUS "=== ä¸€ä½“åŒ–ç«¹å­è¯†åˆ«ç³»ç»Ÿæ„å»ºé…ç½® ===")
message(STATUS "é¡¹ç›®åç§°: ${PROJECT_NAME}")
message(STATUS "ç‰ˆæœ¬: ${PROJECT_VERSION}")
message(STATUS "æ„å»ºç±»å‹: ${CMAKE_BUILD_TYPE}")
message(STATUS "ç›®æ ‡æ¶æ„: ${TARGET_ARCH}")
message(STATUS "C++æ ‡å‡†: ${CMAKE_CXX_STANDARD}")
message(STATUS "å®‰è£…å‰ç¼€: ${CMAKE_INSTALL_PREFIX}")
message(STATUS "")
message(STATUS "ä¾èµ–åº“çŠ¶æ€:")
message(STATUS "  OpenCV: ${ENABLE_OPENCV} (${OpenCV_VERSION})")
message(STATUS "  GStreamer: ${ENABLE_GSTREAMER} (${GSTREAMER_VERSION})")
message(STATUS "  CUDA: ${ENABLE_CUDA}")
message(STATUS "  TensorRT: ${ENABLE_TENSORRT}")
message(STATUS "  libmodbus: ${ENABLE_MODBUS}")
message(STATUS "  nlohmann_json: ${ENABLE_JSON}")
message(STATUS "  Wayland: ${ENABLE_WAYLAND}")
message(STATUS "    - wayland-client: ${WAYLAND_CLIENT_VERSION}")
message(STATUS "    - wayland-egl: ${WAYLAND_EGL_VERSION}")
if(WAYLAND_PROTOCOLS_FOUND)
message(STATUS "    - wayland-protocols: ${WAYLAND_PROTOCOLS_VERSION}")
endif()
message(STATUS "  EGL: ${ENABLE_EGL}")
message(STATUS "  GBM: ${ENABLE_GBM}")
message(STATUS "  OpenGL ES: ${ENABLE_GLES2}")
message(STATUS "  DRMåº“: ${ENABLE_DRM_LIB}")
message(STATUS "  xkbcommon: ${ENABLE_XKBCOMMON}")
message(STATUS "  LVGL: ${ENABLE_LVGL}")
message(STATUS "  cpp_inference: ${ENABLE_CPP_INFERENCE}")
message(STATUS "")
message(STATUS "æ¶æ„è¿ç§»:")
message(STATUS "  DRMç›´æ¥è®¿é—®: å·²æ›¿æ¢ä¸ºDRM EGLå…±äº«æ¶æ„")
message(STATUS "  GBMæ˜¾ç¤ºåç«¯: å·²å¯ç”¨ (DRM EGL)")
message(STATUS "  OpenGL ESæ¸²æŸ“: å·²å¯ç”¨")
message(STATUS "  Waylandåˆæˆå™¨: å·²å¯ç”¨")
message(STATUS "  lv_drivers/wayland: å·²é›†æˆ")
message(STATUS "")
message(STATUS "ç»„ä»¶æ¨¡å—:")
message(STATUS "  cpp_backend: å·²é›†æˆ")
message(STATUS "  lvgl_frontend: å·²é›†æˆ")
if(ENABLE_CPP_INFERENCE)
    message(STATUS "  cpp_inference: å·²é›†æˆ")
else()
    message(STATUS "  cpp_inference: æœªæ‰¾åˆ°")
endif()
message(STATUS "")
message(STATUS "æœ‰æ•ˆæºæ–‡ä»¶æ•°é‡: ${VALID_SOURCES}")
message(STATUS "ç¼–è¯‘å™¨: ${CMAKE_CXX_COMPILER_ID} ${CMAKE_CXX_COMPILER_VERSION}")
message(STATUS "========================================")
