<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIç«¹èŠ‚è¯†åˆ«åˆ‡å‰²ç³»ç»Ÿ v2.1 - Jetson Orin NX é¢„è§ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-main: #0b1220;
            --bg-panel: #111a2b;
            --bg-spot: #142035;
            --text-primary: #e6f0ff;
            --text-secondary: #9bb3d1;
            --accent: #5cc8ff;
            --success: #3ac88f;
            --warning: #ffd166;
            --error: #f45b69;
            --border: #1d2a3d;
            --jetson: #54d3a8;
            --modbus: #4da3ff;
            --power: #6b7cff;
        }

body {
    font-family: 'Microsoft YaHei', 'Consolas', Arial, sans-serif;
    background: radial-gradient(140% 140% at 15% 20%, #1a2f4f 0%, #0f1a2d 40%, #0b1220 85%), linear-gradient(120deg, rgba(92,200,255,0.08), rgba(0,0,0,0));
    color: var(--text-primary);
    min-height: 100vh;
    overflow: hidden;
}

#webrtc-panel { display: none; }
#webrtc-status { font-size: 12px; color: var(--error); }

        .message-bar {
            position: fixed;
            top: 10px;
            right: 10px;
            min-width: 240px;
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--bg-panel);
            color: var(--text-primary);
            box-shadow: 0 10px 26px rgba(0,0,0,0.35);
            opacity: 0;
            transform: translateY(-8px);
            transition: all 0.2s ease;
            z-index: 50;
        }
        .message-bar.show { opacity: 1; transform: translateY(0); }
        .message-bar.success { border-color: var(--success); color: var(--success); }
        .message-bar.error { border-color: var(--error); color: var(--error); }
        .message-bar.warn { border-color: var(--warning); color: var(--warning); }

        /* Calibration floating panel */
        .calib-panel {
            position: fixed;
            right: 14px;
            bottom: 14px;
            width: 320px;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 10px;
            box-shadow: 0 10px 28px rgba(0,0,0,0.35);
            padding: 12px;
            z-index: 999;
        }
        .calib-panel h4 {
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--accent);
        }
        .calib-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        .calib-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .calib-field label {
            font-size: 12px;
            color: var(--text-secondary);
        }
        .calib-field input {
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: rgba(255,255,255,0.04);
            color: var(--text-primary);
        }
        .calib-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .calib-btn {
            flex: 1;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: rgba(255,255,255,0.05);
            color: var(--text-primary);
            cursor: pointer;
            font-weight: 700;
            transition: all 0.2s ease;
        }
        .calib-btn.primary {
            border-color: var(--accent);
            color: var(--accent);
        }
        .calib-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.25);
        }

        .main-container {
            display: grid;
            grid-template-areas:
                "header header"
                "camera control"
                "footer footer";
            grid-template-columns: 1fr 420px;
            grid-template-rows: 68px 1fr 90px;
            gap: 10px;
            height: 100vh;
            padding: 10px;
        }

        .header-panel {
            grid-area: header;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.35);
        }

        .system-title {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .badge {
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            background: linear-gradient(135deg, #1b88ff, #58c4ff);
            color: #031422;
        }

        .workflow-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .settings-btn {
            padding: 6px 10px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.04);
            color: var(--text-primary);
            cursor: pointer;
            font-weight: 700;
            transition: all 0.25s ease;
        }

        .settings-btn:hover {
            transform: translateY(-1px);
            border-color: var(--accent);
            color: var(--accent);
        }

        .workflow-step {
            padding: 6px 10px;
            border-radius: 12px;
            background: var(--bg-spot);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
            color: var(--text-secondary);
        }

        .workflow-step.active {
            background: rgba(255, 122, 61, 0.2);
            color: var(--text-primary);
            border-color: var(--accent);
            box-shadow: 0 0 12px rgba(255, 122, 61, 0.4);
        }

        .workflow-step.completed {
            background: rgba(76, 175, 80, 0.18);
            color: var(--success);
            border-color: var(--success);
        }

        .heartbeat {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--success);
        }

        .heartbeat-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success);
            box-shadow: 0 0 12px rgba(76, 175, 80, 0.8);
            animation: beat 1.2s infinite;
        }

        @keyframes beat {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
        }

        .camera-panel {
            grid-area: camera;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.35);
        }

        .camera-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 16px;
            font-weight: 700;
            color: var(--accent);
        }

        .camera-canvas {
            flex: 1;
            background: linear-gradient(135deg, rgba(33, 45, 63, 0.8), rgba(17, 23, 33, 0.9));
            border: 1px dashed var(--border);
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }
        .camera-canvas video {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000;
            display: none;
        }
        .camera-canvas img {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000;
        }

        .camera-placeholder {
            position: absolute;
            inset: 0;
            display: grid;
            place-items: center;
            color: var(--text-secondary);
            font-size: 14px;
            text-align: center;
        }

        .rail-indicator {
            position: absolute;
            bottom: 12px;
            left: 12px;
            right: 12px;
            height: 28px;
            border-radius: 6px;
            border: 1px solid var(--modbus);
            background: rgba(33, 150, 243, 0.12);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--modbus);
            font-size: 12px;
        }

        .cutting-position {
            position: absolute;
            top: 0;
            width: 2px;
            height: 100%;
            background: var(--error);
            transition: left 0.5s ease;
        }

        .coordinate-display {
            background: var(--bg-spot);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px;
        }

        .coord-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            font-size: 12px;
        }

        .coord-item {
            padding: 6px 8px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border);
        }

        .coord-label { color: var(--text-secondary); }

        .coord-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--accent);
        }

        .control-panel {
            grid-area: control;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.35);
        }

        .panel-section {
            background: var(--bg-spot);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px;
        }

        .section-title {
            font-size: 13px;
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title small { color: var(--text-secondary); font-weight: 400; }

        .registers-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }

        .registers-table th,
        .registers-table td {
            padding: 4px 6px;
            border: 1px solid var(--border);
        }

        .registers-table th {
            background: rgba(33, 150, 243, 0.16);
            color: var(--text-primary);
        }

        .register-addr { color: var(--modbus); font-family: Consolas, monospace; }
        .register-value { color: var(--accent); font-weight: 700; font-family: Consolas, monospace; }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
            font-size: 11px;
        }

        .status-item {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 6px 8px;
            display: flex;
            justify-content: space-between;
        }

        .progress-container { margin-top: 6px; }
        .progress-label { display: flex; justify-content: space-between; font-size: 11px; color: var(--text-secondary); }
        .progress-bar { width: 100%; height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; margin-top: 4px; }
        .progress-fill { height: 100%; border-radius: 4px; transition: width 0.35s ease; }
        .progress-cpu { background: var(--jetson); }
        .progress-gpu { background: var(--accent); }
        .progress-memory { background: var(--warning); }
        .progress-temp { background: var(--error); }

        .mode-pill {
            padding: 2px 6px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.04);
            font-size: 11px;
            color: var(--text-secondary);
        }

        .network-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 6px;
        }

        .form-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 11px;
        }

        .form-field label { color: var(--text-secondary); }

        .form-field input,
        .form-field select {
            background: var(--bg-main);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 6px 8px;
            color: var(--text-primary);
            font-size: 12px;
        }

        .btn-row {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .btn {
            flex: 1;
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--bg-main);
            color: var(--text-primary);
            font-weight: 700;
            cursor: pointer;
            transition: all 0.25s ease;
        }

        .btn:hover { transform: translateY(-1px); border-color: var(--accent); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-accent { background: var(--accent); border-color: var(--accent); color: #0f0f0f; }
        .btn-warning { background: var(--warning); border-color: var(--warning); color: #0f0f0f; }
        .btn-error { background: var(--error); border-color: var(--error); color: #fff; }
        .btn-outline { background: transparent; }

        .footer-panel {
            grid-area: footer;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 -6px 20px rgba(0, 0, 0, 0.35);
        }

        .control-buttons { display: flex; gap: 10px; }
        .emergency-section { display: flex; gap: 10px; }

        .inline-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid var(--border);
            font-size: 12px;
            color: var(--text-secondary);
        }

        .status-good { color: var(--success); }
        .status-bad { color: var(--error); }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.55);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 20;
        }

        .modal {
            width: 720px;
            max-width: 90vw;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.45);
            padding: 14px;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: 700;
            font-size: 16px;
        }

        .modal-close {
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            border-radius: 8px;
            padding: 6px 10px;
            cursor: pointer;
        }

        .modal-body {
            display: grid;
            gap: 10px;
        }

        .modal-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .modal-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        @media (max-width: 1400px) {
            .main-container { grid-template-columns: 1fr 380px; }
        }
    </style>
</head>
<body>
    <div id="message-bar" class="message-bar"></div>
    <div class="main-container">
        <div class="header-panel">
            <div class="system-title">
                <span class="badge">Jetson Orin NX Â· Modbus TCP</span>
            </div>
            <div class="header-actions">
                <div class="workflow-status">
                    <div class="workflow-step" id="step-1">è¿›æ–™æ£€æµ‹</div>
                    <div class="workflow-step" id="step-2">è§†è§‰è¯†åˆ«</div>
                    <div class="workflow-step" id="step-3">åæ ‡ä¼ è¾“</div>
                    <div class="workflow-step" id="step-4">åˆ‡å‰²å‡†å¤‡</div>
                    <div class="workflow-step" id="step-5">æ‰§è¡Œåˆ‡å‰²</div>
                </div>
                <button class="settings-btn" id="settings-btn">âš™ï¸ è®¾ç½®</button>
                <div class="heartbeat">
                    <div class="heartbeat-dot"></div>
                    <span>å¿ƒè·³ <span id="heartbeat-counter">12345</span></span>
                    <span class="inline-pill">å“åº” <span id="response-time">12ms</span></span>
                </div>
            </div>
        </div>

        <div class="camera-panel">
            <div class="camera-title">
                ğŸ“¹ å®æ—¶æ£€æµ‹ç”»é¢
                <span style="color: var(--text-secondary); font-size: 12px;">1280x720 | YOLOv8 | 0.1mm ç²¾åº¦ | WebRTC</span>
            </div>
            <div class="camera-canvas">
                <img id="streamImage" alt="MJPEG Stream">
                <div class="camera-placeholder" id="camera-placeholder">
                    <div>
                        <div>ç«¹ææ£€æµ‹é¢„è§ˆï¼šWebRTCï¼ˆè‡ªåŠ¨è¿æ¥ï¼‰</div>
                        <small>æ¨ç†æ—¶é—´ <span id="inference-time">15.3ms</span> Â· FPS <span id="detection-fps">28.5</span></small>
                    </div>
                </div>
                <div class="rail-indicator">
                    Xè½´å¯¼è½¨ (0 - 1000.0 mm)
                    <div class="cutting-position" id="cutting-position" style="left: 25%;"></div>
                </div>
            </div>
            <div class="coordinate-display">
                <div class="coord-grid">
                    <div class="coord-item">
                        <div class="coord-label">Xåæ ‡</div>
                        <div class="coord-value" id="x-coordinate">245.8mm</div>
                    </div>
                    <div class="coord-item">
                        <div class="coord-label">åˆ€ç‰‡é€‰æ‹©</div>
                        <div class="coord-value" id="blade-selection">åŒåˆ€ç‰‡</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="control-panel">
            <div class="panel-section modbus-section">
                <div class="section-title">ğŸ“Š Modbus å¯„å­˜å™¨çŠ¶æ€ <small>40001+</small></div>
                <table class="registers-table">
                    <thead>
                        <tr>
                            <th>åœ°å€</th>
                            <th>æè¿°</th>
                            <th>å€¼</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td class="register-addr">40001</td><td>ç³»ç»ŸçŠ¶æ€</td><td class="register-value" id="reg-40001">1</td></tr>
                        <tr><td class="register-addr">40002</td><td>PLC å‘½ä»¤</td><td class="register-value" id="reg-40002">2</td></tr>
                        <tr><td class="register-addr">40003</td><td>åæ ‡å°±ç»ª</td><td class="register-value" id="reg-40003">1</td></tr>
                        <tr><td class="register-addr">40004-40005</td><td>X åæ ‡</td><td class="register-value" id="reg-40004">2458</td></tr>
                        <tr><td class="register-addr">40007-40008</td><td>å¿ƒè·³è®¡æ•°</td><td class="register-value" id="reg-40007">12345</td></tr>
                        <tr><td class="register-addr">40009</td><td>åˆ€ç‰‡ç¼–å·</td><td class="register-value" id="reg-40009">3</td></tr>
                        <tr><td class="register-addr">40010</td><td>å¥åº·çŠ¶æ€</td><td class="register-value" id="reg-40010">0</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="panel-section plc-section">
                <div class="section-title">ğŸ”Œ PLC / ç°åœº IO</div>
                <div class="status-grid">
                    <div class="status-item"><span>PLC è¿æ¥</span><span class="status-good" id="plc-link">åœ¨çº¿</span></div>
                    <div class="status-item"><span>å“åº”</span><span id="plc-response">12ms</span></div>
                    <div class="status-item"><span>æ€¥åœå›è·¯</span><span class="status-good">é—­åˆ</span></div>
                    <div class="status-item"><span>æ°”å‹</span><span>0.62 MPa</span></div>
                </div>
            </div>

            <div class="panel-section jetson-section">
                <div class="section-title">ğŸŸ¢ Jetson Orin NX çŠ¶æ€ <small>æ—  X11ï¼Œé€‚é…æ— å¤´è¿è¡Œ</small></div>
                <div class="progress-container">
                    <div class="progress-label"><span>CPU</span><span id="cpu-usage">45%</span></div>
                    <div class="progress-bar"><div class="progress-fill progress-cpu" id="cpu-progress" style="width: 45%;"></div></div>
                    <div class="progress-label"><span>GPU</span><span id="gpu-usage">32%</span></div>
                    <div class="progress-bar"><div class="progress-fill progress-gpu" id="gpu-progress" style="width: 32%;"></div></div>
                    <div class="progress-label"><span>å†…å­˜</span><span id="memory-usage">2.1GB/8GB</span></div>
                    <div class="progress-bar"><div class="progress-fill progress-memory" id="memory-progress" style="width: 26%;"></div></div>
                    <div class="progress-label"><span>æ¸©åº¦</span><span id="thermal-temp">52Â°C</span></div>
                    <div class="progress-bar"><div class="progress-fill progress-temp" id="temp-progress" style="width: 52%;"></div></div>
                </div>
                <div class="status-grid" style="margin-top: 6px;">
                    <div class="status-item"><span>åŠŸè€—</span><span id="power-draw">8.2W</span></div>
                    <div class="status-item"><span>é£æ‰‡</span><span id="fan-speed">2150 RPM</span></div>
                    <div class="status-item"><span>EMC</span><span id="emc-freq">2133 MHz</span></div>
                    <div class="status-item"><span>è¿è¡Œæ—¶é•¿</span><span id="uptime">2d 3h 15m</span></div>
                    <div class="status-item"><span>æ€§èƒ½æ¨¡å¼</span><span id="perf-mode">15W</span></div>
                    <div class="status-item"><span>NVPModel</span><span id="nvpmodel">æœªçŸ¥</span></div>
                </div>
            </div>

            <div class="panel-section ai-section">
                <div class="section-title">ğŸ§  æ¨¡å‹ & æ£€æµ‹</div>
                <div class="status-grid">
                    <div class="status-item"><span>æ¨¡å‹ç‰ˆæœ¬</span><span>YOLOv8n</span></div>
                    <div class="status-item"><span>æ¨ç†æ—¶é—´</span><span id="model-inference">15.3ms</span></div>
                    <div class="status-item"><span>ç½®ä¿¡é˜ˆå€¼</span><span>0.85</span></div>
                    <div class="status-item"><span>æ£€æµ‹ç²¾åº¦</span><span>94.2%</span></div>
                    <div class="status-item"><span>æ€»æ£€æµ‹æ•°</span><span id="total-detections">15,432</span></div>
                    <div class="status-item"><span>ä»Šæ—¥æ£€æµ‹</span><span id="today-detections">89</span></div>
                </div>
            </div>

            <div class="panel-section communication-section">
                <div class="section-title">ğŸ“ˆ é€šä¿¡ç»Ÿè®¡</div>
                <div class="status-grid">
                    <div class="status-item"><span>è¿æ¥æ—¶é•¿</span><span id="connection-time">2h 15m</span></div>
                    <div class="status-item"><span>æ•°æ®åŒ…</span><span id="data-packets">15,432</span></div>
                    <div class="status-item"><span>é”™è¯¯ç‡</span><span id="error-rate">0.02%</span></div>
                    <div class="status-item"><span>åå</span><span id="throughput">1.2KB/s</span></div>
                    <div class="status-item"><span>Wi-Fi</span><span id="wifi-summary">wlan0 | å·²è¿æ¥</span></div>
                    <div class="status-item"><span>Wi-Fi æ¨¡å¼</span><span id="wifi-mode">DHCP</span></div>
                </div>
            </div>

        </div>

        <div class="footer-panel">
            <div class="control-buttons">
                <button class="btn btn-accent" id="start-btn">å¯åŠ¨ç³»ç»Ÿ</button>
                <button class="btn" id="pause-btn">æš‚åœ</button>
                <button class="btn btn-outline" id="stop-btn">åœæ­¢</button>
            </div>
            <div style="text-align: center; color: var(--text-secondary);">
                <div>å½“å‰å·¥åº: <span id="current-process">è¿›æ–™æ£€æµ‹ä¸­</span></div>
                <div style="font-size: 12px; margin-top: 4px;">ä¸Šæ¬¡åˆ‡å‰² 14:25:33 | ä»Šæ—¥åˆ‡å‰² <span id="daily-cuts">89</span> | æ•ˆç‡ <span id="efficiency">94.2%</span></div>
            </div>
            <div class="emergency-section">
                <button class="btn btn-error" id="emergency-btn">ğŸš¨ ç´§æ€¥åœæœº</button>
                <button class="btn" id="power-btn">â» å…³æœº</button>
            </div>
        </div>
    </div>

    <div class="modal-backdrop" id="settings-modal">
        <div class="modal">
            <div class="modal-header">
                ç³»ç»Ÿè®¾ç½®
                <button class="modal-close" id="modal-close">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="panel-section">
                    <div class="section-title">ğŸ›¡ï¸ ç”µæºæ§åˆ¶ï¼ˆæ— å¤´ï¼‰</div>
                    <div class="modal-actions">
                        <button class="btn btn-warning" id="modal-reboot-btn">é‡å¯ Jetson</button>
                        <button class="btn btn-error" id="modal-shutdown-btn">å®‰å…¨å…³æœº</button>
                        <button class="btn btn-outline" id="modal-restart-service-btn">é‡å¯æ¨ç†/Modbus æœåŠ¡</button>
                    </div>
                </div>
                <div class="panel-section">
                    <div class="section-title">âš¡ æ€§èƒ½æ¨¡å¼</div>
                    <div class="modal-actions">
                        <button class="btn btn-outline perf-btn" data-mode="10W">10W</button>
                        <button class="btn btn-outline perf-btn" data-mode="15W">15W</button>
                        <button class="btn btn-outline perf-btn" data-mode="MAXN">MAXN</button>
                    </div>
                </div>
                <div class="panel-section">
                    <div class="section-title">ğŸ“¶ Wi-Fi é…ç½®</div>
                    <div class="modal-row">
                        <div class="form-field">
                            <label for="wifi-ssid">SSID</label>
                            <input id="wifi-ssid" value="FactoryWiFi">
                        </div>
                        <div class="form-field">
                            <label for="wifi-password">å¯†ç </label>
                            <input id="wifi-password" type="password" value="******">
                        </div>
                        <div class="form-field">
                            <label for="wifi-security">å®‰å…¨</label>
                            <select id="wifi-security">
                                <option value="WPA2-PSK">WPA2-PSK</option>
                                <option value="WPA3">WPA3</option>
                                <option value="OPEN">å¼€æ”¾</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label for="wifi-mode-select">è·å–åœ°å€</label>
                            <select id="wifi-mode-select">
                                <option value="dhcp">DHCP</option>
                                <option value="static">é™æ€</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label for="wifi-ip">IP åœ°å€</label>
                            <input id="wifi-ip" value="192.168.1.120">
                        </div>
                        <div class="form-field">
                            <label for="wifi-mask">å­ç½‘æ©ç </label>
                            <input id="wifi-mask" value="255.255.255.0">
                        </div>
                        <div class="form-field">
                            <label for="wifi-gateway">ç½‘å…³</label>
                            <input id="wifi-gateway" value="192.168.1.1">
                        </div>
                        <div class="form-field">
                            <label for="wifi-dns">DNS</label>
                            <input id="wifi-dns" value="223.5.5.5">
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button class="btn btn-accent" id="apply-wifi-btn">åº”ç”¨ Wi-Fi</button>
                        <button class="btn" id="check-wifi-btn">è¿é€šæ€§æ£€æµ‹</button>
                        <button class="btn btn-outline" id="restart-wifi-btn">é‡å¯ Wi-Fi æœåŠ¡</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="webrtc-panel">
        <!-- WebRTC é¢„è§ˆ -->
    </div>

    <!-- Calibration floating panel -->
    <div class="calib-panel">
        <h4>åœ¨çº¿æ ‡å®š</h4>
        <div class="calib-grid">
            <div class="calib-field">
                <label for="calib-pxmm">åƒç´ â†’æ¯«ç±³</label>
                <input id="calib-pxmm" type="number" step="0.0001" placeholder="pixel_to_mm">
            </div>
            <div class="calib-field">
                <label for="calib-offset">åæ ‡åç§»(mm)</label>
                <input id="calib-offset" type="number" step="0.1" placeholder="offset_mm">
            </div>
            <div class="calib-field">
                <label for="calib-latency">å»¶è¿Ÿ(ms)</label>
                <input id="calib-latency" type="number" step="1" placeholder="latency_ms">
            </div>
            <div class="calib-field">
                <label for="calib-speed">çš®å¸¦é€Ÿåº¦(mm/s)</label>
                <input id="calib-speed" type="number" step="1" placeholder="belt_speed_mm_s">
            </div>
        </div>
        <div class="calib-actions">
            <button class="calib-btn" id="calib-refresh">åˆ·æ–°</button>
            <button class="calib-btn primary" id="calib-save">ä¿å­˜</button>
        </div>
        <div id="calib-status" style="margin-top:6px;font-size:12px;color:var(--text-secondary);">ç­‰å¾…æ“ä½œ</div>
        <div style="margin-top:8px;">
            <div style="font-size:12px;color:var(--text-secondary);margin-bottom:4px;">ç›¸æœºæ ‡å®š (calibrate-camera)</div>
            <div class="calib-actions">
                <button class="calib-btn" id="calib-run-cam0">æ ‡å®š Cam0</button>
                <button class="calib-btn" id="calib-run-cam1">æ ‡å®š Cam1</button>
                <button class="calib-btn" id="calib-stop">åœæ­¢</button>
            </div>
            <div id="calib-run-status" style="font-size:12px;color:var(--text-secondary);margin-top:4px;">æœªè¿è¡Œ</div>
        </div>
    </div>

    <script>
        // æ¨¡æ‹Ÿæ•°æ®ï¼ˆé¢„è§ˆç”¨ï¼ŒQt ç‰ˆæœ¬è¯·ç»‘å®šçœŸå®æ¥å£ï¼‰
        const systemState = {
            isRunning: false,
            currentStep: 1,
            heartbeat: 12345,
            xCoordinate: 245.8,
            cutQuality: 0,
            bladeSelection: 3,
            plcCommand: 0,
            coordinateReady: 0
        };

        const jetsonData = {
            cpu: { usage: 45, temp: 52 },
            gpu: { usage: 32, temp: 49 },
            memory: { used: 2.1, total: 8 },
            thermal: { temp: 52 },
            fan: { speed: 2150 },
            power: { draw: 8.2 },
            emc: { freq: 2133 },
            uptime: { days: 2, hours: 3, minutes: 15 }
        };

        const aiModelData = {
            inferenceTime: 15.3,
            detectionFps: 28.5,
            totalDetections: 15432,
            todayDetections: 89,
            accuracy: 94.2
        };

        const wifiState = {
            iface: 'wlan0',
            ssid: 'FactoryWiFi',
            password: '******',
            security: 'WPA2-PSK',
            mode: 'dhcp',
            ip: '192.168.1.120',
            mask: '255.255.255.0',
            gateway: '192.168.1.1',
            dns: '223.5.5.5',
            status: 'å·²è¿æ¥',
            rssi: -55
        };

        const performanceState = { mode: '15W' };

        const workflowSteps = [
            { id: 1, name: 'è¿›æ–™æ£€æµ‹', plcCmd: 1 },
            { id: 2, name: 'è§†è§‰è¯†åˆ«', plcCmd: 0 },
            { id: 3, name: 'åæ ‡ä¼ è¾“', plcCmd: 0 },
            { id: 4, name: 'åˆ‡å‰²å‡†å¤‡', plcCmd: 2 },
            { id: 5, name: 'æ‰§è¡Œåˆ‡å‰²', plcCmd: 3 }
        ];

        const statusMaps = {
            cutQuality: ['æ­£å¸¸', 'å¼‚å¸¸'],
            bladeType: ['æœªé€‰', 'åˆ€ç‰‡A', 'åˆ€ç‰‡B', 'åŒåˆ€ç‰‡']
        };

        let messageTimer = null;
        function showMessage(text, type = 'info') {
            const bar = document.getElementById('message-bar');
            if (!bar) {
                console.log(text);
                return;
            }
            bar.textContent = text;
            bar.className = 'message-bar show';
            if (type && type !== 'info') {
                bar.classList.add(type === 'warning' ? 'warn' : type);
            }
            clearTimeout(messageTimer);
            messageTimer = setTimeout(() => {
                bar.classList.remove('show', 'success', 'error', 'warn');
            }, 3200);
        }

        function updateHeartbeat() {
            systemState.heartbeat += 1;
            document.getElementById('heartbeat-counter').textContent = systemState.heartbeat;
            document.getElementById('reg-40007').textContent = systemState.heartbeat;
        }

        async function updateJetsonInfo() {
            try {
                const res = await fetch('/api/jetson');
                if (!res.ok) throw new Error(res.statusText);
                const d = await res.json();
                jetsonData.cpu.usage = d.cpu || 0;
                jetsonData.gpu.usage = d.gpu || 0;
                jetsonData.memory.total = (d.mem_total_mb || 0) / 1024;
                jetsonData.memory.used = (d.mem_used_mb || 0) / 1024;
                jetsonData.cpu.temp = d.temp_c || 0;
                jetsonData.gpu.temp = d.temp_c || 0;
                jetsonData.thermal.temp = d.temp_c || 0;
                jetsonData.fan.speed = d.fan_rpm || 0;
                jetsonData.power.draw = d.power_w || 0;
                jetsonData.emc.freq = d.emc_mhz || 0;
                const nvp = d.nvpmodel || performanceState.mode;
                const nvpEl = document.getElementById('nvpmodel');
                performanceState.mode = nvp;
                const up = d.uptime_sec || 0;
                jetsonData.uptime.days = Math.floor(up / 86400);
                jetsonData.uptime.hours = Math.floor((up % 86400) / 3600);
                jetsonData.uptime.minutes = Math.floor((up % 3600) / 60);

                document.getElementById('cpu-usage').textContent = jetsonData.cpu.usage.toFixed(1) + '%';
                document.getElementById('cpu-progress').style.width = jetsonData.cpu.usage + '%';
                document.getElementById('gpu-usage').textContent = jetsonData.gpu.usage.toFixed(1) + '%';
                document.getElementById('gpu-progress').style.width = jetsonData.gpu.usage + '%';

                const memPercent = (jetsonData.memory.used / Math.max(jetsonData.memory.total, 0.001)) * 100;
                document.getElementById('memory-usage').textContent = jetsonData.memory.used.toFixed(1) + 'GB/' + jetsonData.memory.total.toFixed(1) + 'GB';
                document.getElementById('memory-progress').style.width = memPercent + '%';

                document.getElementById('thermal-temp').textContent = jetsonData.thermal.temp.toFixed(0) + 'Â°C';
                const tempPercent = Math.min(100, Math.max(0, jetsonData.thermal.temp));
                document.getElementById('temp-progress').style.width = tempPercent + '%';
                const fanVal = jetsonData.fan.speed;
                document.getElementById('fan-speed').textContent = fanVal > 0 ? `${fanVal.toFixed(0)} RPM` : '-';
                document.getElementById('power-draw').textContent = jetsonData.power.draw.toFixed(1) + 'W';
                document.getElementById('emc-freq').textContent = jetsonData.emc.freq + ' MHz';
                document.getElementById('uptime').textContent = `${jetsonData.uptime.days}d ${jetsonData.uptime.hours}h ${jetsonData.uptime.minutes}m`;
                document.getElementById('perf-mode').textContent = nvp;
                if (nvpEl) nvpEl.textContent = nvp || 'æœªçŸ¥';
            } catch (e) {
                console.warn('jetson info fetch failed', e);
            }
        }

        function updateWorkflowStatus(step) {
            for (let i = 1; i <= 5; i++) {
                const el = document.getElementById(`step-${i}`);
                el.classList.remove('active', 'completed');
                if (i < step) el.classList.add('completed');
                if (i === step) el.classList.add('active');
            }
            systemState.currentStep = step;
            document.getElementById('current-process').textContent = workflowSteps[step - 1].name;
        }

        function updateModbusRegisters() {
            document.getElementById('reg-40001').textContent = systemState.isRunning ? 1 : 0;
            document.getElementById('reg-40002').textContent = systemState.plcCommand;
            document.getElementById('reg-40003').textContent = systemState.coordinateReady;
            document.getElementById('reg-40004').textContent = Math.round(systemState.xCoordinate * 10);
            document.getElementById('reg-40006').textContent = systemState.cutQuality;
            document.getElementById('reg-40009').textContent = systemState.bladeSelection;
            document.getElementById('reg-40010').textContent = 0;

            document.getElementById('x-coordinate').textContent = systemState.xCoordinate.toFixed(1) + 'mm';
            document.getElementById('cut-quality').textContent = statusMaps.cutQuality[systemState.cutQuality];
            document.getElementById('blade-selection').textContent = statusMaps.bladeType[systemState.bladeSelection];

            const pos = (systemState.xCoordinate / 1000) * 100;
            document.getElementById('cutting-position').style.left = `${pos}%`;
        }

        function simulateWorkflow() {
            if (!systemState.isRunning) return;
            const step = systemState.currentStep;
            switch (step) {
                case 1:
                    systemState.plcCommand = 1;
                    setTimeout(() => { updateWorkflowStatus(2); simulateWorkflow(); }, 1500);
                    break;
                case 2:
                    systemState.plcCommand = 0;
                    systemState.xCoordinate = 200 + Math.random() * 600;
                    systemState.coordinateReady = 1;
                    setTimeout(() => { updateWorkflowStatus(3); simulateWorkflow(); }, 1200);
                    break;
                case 3:
                    setTimeout(() => { updateWorkflowStatus(4); simulateWorkflow(); }, 800);
                    break;
                case 4:
                    systemState.plcCommand = 2;
                    setTimeout(() => { updateWorkflowStatus(5); simulateWorkflow(); }, 2000);
                    break;
                case 5:
                    systemState.plcCommand = 3;
                    setTimeout(() => {
                        systemState.coordinateReady = 0;
                        aiModelData.todayDetections += 1;
                        aiModelData.totalDetections += 1;
                        document.getElementById('today-detections').textContent = aiModelData.todayDetections;
                        document.getElementById('total-detections').textContent = aiModelData.totalDetections.toLocaleString();
                        updateWorkflowStatus(1);
                        simulateWorkflow();
                    }, 1500);
                    break;
            }
            updateModbusRegisters();
        }

        function updateWifiUI() {
            const disableStatic = wifiState.mode === 'dhcp';
            ['wifi-ip','wifi-mask','wifi-gateway','wifi-dns'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.disabled = disableStatic;
            });
            const summary = `${wifiState.iface} | ${wifiState.status}${wifiState.rssi ? ` | ${wifiState.rssi} dBm` : ''}`;
            document.getElementById('wifi-summary').textContent = summary;
            document.getElementById('wifi-mode').textContent = wifiState.mode.toUpperCase();

            const ssidEl = document.getElementById('wifi-ssid');
            if (ssidEl) {
                ssidEl.value = wifiState.ssid;
                document.getElementById('wifi-password').value = wifiState.password;
                document.getElementById('wifi-security').value = wifiState.security;
                document.getElementById('wifi-mode-select').value = wifiState.mode;
                document.getElementById('wifi-ip').value = wifiState.ip;
                document.getElementById('wifi-mask').value = wifiState.mask;
                document.getElementById('wifi-gateway').value = wifiState.gateway;
                document.getElementById('wifi-dns').value = wifiState.dns;
            }
        }

        
                async function applyWifiConfig() {
            const payload = {
                ssid: document.getElementById('wifi-ssid').value,
                password: document.getElementById('wifi-password').value,
                security: document.getElementById('wifi-security').value,
                mode: document.getElementById('wifi-mode-select').value,
                ip: document.getElementById('wifi-ip').value,
                mask: document.getElementById('wifi-mask').value,
                gateway: document.getElementById('wifi-gateway').value,
                dns: document.getElementById('wifi-dns').value,
            };
            try {
                const res = await fetch('/api/wifi', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const data = await res.json();
                if (!data.ok) throw new Error(data.error || 'apply failed');
                wifiState.ssid = payload.ssid;
                wifiState.password = payload.password;
                wifiState.security = payload.security;
                wifiState.mode = payload.mode;
                wifiState.ip = data.ip || payload.ip;
                wifiState.mask = payload.mask;
                wifiState.gateway = data.gateway || payload.gateway;
                wifiState.dns = data.dns || payload.dns;
                wifiState.status = 'å·²åº”ç”¨';
                wifiState.rssi = data.wifi && data.wifi.signal ? -Math.abs(parseInt(data.wifi.signal, 10)) : null;
                updateWifiUI();
                showMessage('Wi-Fi å·²åº”ç”¨', 'success');
            } catch (e) {
                showMessage('Wi-Fi åº”ç”¨å¤±è´¥: ' + e.message, 'error');
            }
        }

        async function checkWifi() {
            try {
                const res = await fetch('/api/wifi');
                const data = await res.json();
                if (!data.ok) throw new Error(data.error || 'wifi status error');
                wifiState.ssid = data.wifi && data.wifi.ssid ? data.wifi.ssid : '';
                wifiState.rssi = data.wifi && data.wifi.signal ? -Math.abs(parseInt(data.wifi.signal, 10)) : null;
                wifiState.status = data.connection ? 'å·²è¿æ¥' : 'æœªè¿æ¥';
                wifiState.ip = data.ip || '';
                wifiState.gateway = data.gateway || '';
                wifiState.dns = data.dns || '';
                updateWifiUI();
            } catch (e) {
                showMessage('Wi-Fi çŠ¶æ€æŸ¥è¯¢å¤±è´¥: ' + e.message, 'warn');
            }
        }

        async function restartWifiService() {
            try {
                const res = await fetch('/api/wifi/restart', { method: 'POST' });
                const data = await res.json();
                if (!data.ok) throw new Error(data.error || 'restart failed');
                showMessage('Wi-Fi å·²é‡å¯', 'success');
            } catch (e) {
                showMessage('Wi-Fi é‡å¯å¤±è´¥: ' + e.message, 'error');
            }
        }

        async function handlePowerAction(action) {
            try {
                const res = await fetch('/api/power', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action })
                });
                const data = await res.json();
                if (!data.ok) throw new Error(data.stderr || data.error || 'command failed');
                showMessage('å‘½ä»¤å·²æ‰§è¡Œ: ' + action, 'success');
            } catch (e) {
                showMessage('æ‰§è¡Œå¤±è´¥: ' + e.message, 'error');
            }
        }

        function openSettingsModal() {
            document.getElementById('settings-modal').style.display = 'flex';
        }

        function closeSettingsModal() {
            document.getElementById('settings-modal').style.display = 'none';
        }

        document.getElementById('start-btn').addEventListener('click', () => {
            fetch('/api/control', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'start' }) })
                .then(() => {
                    systemState.isRunning = true;
                    document.getElementById('start-btn').disabled = true;
                    document.getElementById('start-btn').textContent = 'è¿è¡Œä¸­';
                    updateWorkflowStatus(1);
                    showMessage('å·²å‘é€å¯åŠ¨æŒ‡ä»¤', 'success');
                })
                .catch(() => {});
        });

        document.getElementById('pause-btn').addEventListener('click', () => {
            fetch('/api/control', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'pause' }) })
                .then(() => {
                    systemState.isRunning = false;
                    document.getElementById('start-btn').disabled = false;
                    document.getElementById('start-btn').textContent = 'æ¢å¤è¿è¡Œ';
                    showMessage('å·²æš‚åœæ¨ç†/è¾“å‡º', 'warn');
                })
                .catch(() => {});
        });

        document.getElementById('stop-btn').addEventListener('click', () => {
            fetch('/api/control', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'stop' }) })
                .then(() => {
                    systemState.isRunning = false;
                    document.getElementById('start-btn').disabled = false;
                    document.getElementById('start-btn').textContent = 'å¯åŠ¨ç³»ç»Ÿ';
                    updateWorkflowStatus(1);
                    showMessage('å·²åœæ­¢æ¨ç†/è¾“å‡º', 'warn');
                })
                .catch(() => {});
        });

        document.getElementById('emergency-btn').addEventListener('click', () => {
            fetch('/api/control', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'emergency_stop' }) })
                .then(() => {
                    systemState.isRunning = false;
                    ['step-1','step-2','step-3','step-4','step-5'].forEach(id => {
                        const el = document.getElementById(id);
                        el.classList.remove('active', 'completed');
                        el.style.borderColor = 'var(--error)';
                        el.style.color = 'var(--error)';
                    });
                    document.getElementById('current-process').textContent = 'ğŸš¨ ç´§æ€¥åœæœº';
                    showMessage('å·²è§¦å‘ç´§æ€¥åœæœº', 'error');
                })
                .catch(() => {});
        });

        document.getElementById('power-btn').addEventListener('click', openSettingsModal);
        document.getElementById('settings-btn').addEventListener('click', openSettingsModal);
        document.getElementById('modal-close').addEventListener('click', closeSettingsModal);
        document.getElementById('settings-modal').addEventListener('click', (e) => {
            if (e.target.id === 'settings-modal') closeSettingsModal();
        });

        document.getElementById('modal-shutdown-btn').addEventListener('click', () => handlePowerAction('shutdown'));
        document.getElementById('modal-reboot-btn').addEventListener('click', () => handlePowerAction('reboot'));
        document.getElementById('modal-restart-service-btn').addEventListener('click', () => handlePowerAction('restartService'));

        document.querySelectorAll('.perf-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                performanceState.mode = btn.dataset.mode;
                updateJetsonInfo();
                showMessage(`[é¢„è§ˆ] æ€§èƒ½æ¨¡å¼åˆ‡æ¢åˆ° ${btn.dataset.mode}ï¼Œå®é™…éƒ¨ç½²è¯·è°ƒç”¨ nvpmodel`, 'warn');
            });
        });

        document.getElementById('apply-wifi-btn').addEventListener('click', applyWifiConfig);
        document.getElementById('check-wifi-btn').addEventListener('click', checkWifi);
        document.getElementById('restart-wifi-btn').addEventListener('click', restartWifiService);
        document.getElementById('wifi-mode-select').addEventListener('change', (e) => {
            wifiState.mode = e.target.value;
            updateWifiUI();
        });

        // --- Live data from backend instead of simulation ---
        const applyStatus = (data) => {
            if (!data) return;
            const hb = data.heartbeat ?? 0;
            document.getElementById('heartbeat-counter').textContent = hb;
            document.getElementById('plc-response').textContent = data.plc?.ready ? 'ready' : 'busy';
            if (data.control) {
                const running = !!data.control.running;
                const mode = data.control.mode || 'stop';
                const startBtn = document.getElementById('start-btn');
                if (startBtn) {
                    startBtn.disabled = running;
                    startBtn.textContent = running ? 'è¿è¡Œä¸­' : (mode === 'pause' ? 'æ¢å¤è¿è¡Œ' : 'å¯åŠ¨ç³»ç»Ÿ');
                }
                const procEl = document.getElementById('current-process');
                if (!running && mode === 'emergency' && procEl) {
                    procEl.textContent = 'ğŸš¨ ç´§æ€¥åœæœº';
                }
                const sysReg = document.getElementById('reg-40001');
                if (sysReg) sysReg.textContent = running ? 1 : 0;
            }
            if (data.fps !== undefined) {
                document.getElementById('detection-fps').textContent = data.fps.toFixed(1);
                const infMs = data.fps > 0 ? (1000.0 / data.fps) : 0;
                document.getElementById('inference-time').textContent = infMs.toFixed(1) + 'ms';
            }
            if (data.last_detection) {
                const x = data.last_detection.x_mm ?? 0;
                document.getElementById('x-coordinate').textContent = `${x.toFixed(1)}mm`;
                const pos = Math.max(0, Math.min(100, (x / 1000) * 100));
                document.getElementById('cutting-position').style.left = `${pos}%`;
                const conf = data.last_detection.conf ?? 0;
                document.getElementById('cut-quality').textContent = conf > 0.5 ? 'æ­£å¸¸' : 'ä½ç½®ä¿¡åº¦';
            }
            if (data.plc) {
                document.getElementById('reg-40002').textContent = data.plc.state ?? 0;
                document.getElementById('reg-40003').textContent = data.plc.ready ? 1 : 0;
                const pos = data.plc.pos ?? 0;
                document.getElementById('reg-40004').textContent = Math.round(pos * 10);
            }
        };

        const pollStatus = async () => {
            try {
                const res = await fetch('/api/status');
                if (!res.ok) throw new Error(res.statusText);
                const data = await res.json();
                applyStatus(data);
            } catch (e) {
                console.warn('status poll failed', e);
            }
        };

        updateWifiUI();
        updateWorkflowStatus(1);
        pollStatus();
        setInterval(pollStatus, 1000);

        // ç‚¹å‡»ç”»é¢è®¾ç½®æ ‡å°ºé›¶ç‚¹ ref_px
        (function bindRefPixelSetter() {
            const img = document.getElementById('streamImage');
            if (!img) return;
            img.addEventListener('click', async (ev) => {
                const rect = img.getBoundingClientRect();
                const ratioX = (ev.clientX - rect.left) / rect.width;
                const natW = img.naturalWidth || 960;
                const refPx = Math.round(ratioX * natW);
                try {
                    const res = await fetch('/api/calibration', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ref_px: refPx, persist: true })
                    });
                    const data = await res.json();
                    if (!data.ok) throw new Error(data.error || 'calibration update failed');
                    showMessage(`æ ‡å°ºé›¶ç‚¹è®¾ç½®ä¸ºåƒç´  ${refPx}`, 'success');
                } catch (e) {
                    showMessage('æ ‡å°ºé›¶ç‚¹è®¾ç½®å¤±è´¥: ' + e.message, 'error');
                }
            });
        })();

        // WebSocket JPEG stream (binary)
        (function initWebSocketStream() {
            const img = document.getElementById('streamImage');
            const statusEl = document.getElementById('webrtc-status');
            const wsPort = 8765;
            if (!img) return;

            const setStatus = (txt, good = false) => {
                if (!statusEl) return;
                statusEl.textContent = txt;
                statusEl.style.color = good ? '#4caf50' : '#f44336';
            };

            let ws;
            const connect = () => {
                ws = new WebSocket(`ws://${location.hostname || '127.0.0.1'}:${wsPort}`);
                ws.binaryType = 'arraybuffer';
                ws.onopen = () => setStatus('WebSocket å·²è¿æ¥', true);
                ws.onclose = () => {
                    setStatus('æœªè¿æ¥');
                    setTimeout(connect, 2000);
                };
                ws.onerror = () => {
                    setStatus('è¿æ¥é”™è¯¯');
                    ws.close();
                };
                ws.onmessage = (ev) => {
                    const blob = new Blob([ev.data], { type: 'image/jpeg' });
                    const url = URL.createObjectURL(blob);
                    img.src = url;
                    img.onload = () => URL.revokeObjectURL(url);
                };
            };
            connect();
        })();

        // Calibration API integration
        (function initCalibration() {
            const pxmm = document.getElementById('calib-pxmm');
            const offset = document.getElementById('calib-offset');
            const latency = document.getElementById('calib-latency');
            const speed = document.getElementById('calib-speed');
            const statusEl = document.getElementById('calib-status');
            const btnRefresh = document.getElementById('calib-refresh');
            const btnSave = document.getElementById('calib-save');
            const btnRunCam0 = document.getElementById('calib-run-cam0');
            const btnRunCam1 = document.getElementById('calib-run-cam1');
            const btnRunStop = document.getElementById('calib-stop');
            const runStatus = document.getElementById('calib-run-status');
            if (!pxmm || !offset || !latency || !speed || !statusEl) return;

            const setStatus = (txt, good = false) => {
                statusEl.textContent = txt;
                statusEl.style.color = good ? '#4caf50' : 'var(--text-secondary)';
            };
            const setRunStatus = (txt, good = false) => {
                if (!runStatus) return;
                runStatus.textContent = txt;
                runStatus.style.color = good ? '#4caf50' : 'var(--text-secondary)';
            };

            const fill = (calib) => {
                if (!calib) return;
                pxmm.value = calib.pixel_to_mm ?? '';
                offset.value = calib.offset_mm ?? '';
                latency.value = calib.latency_ms ?? '';
                speed.value = calib.belt_speed_mm_s ?? '';
            };

            const refresh = async () => {
                try {
                    const res = await fetch('/api/status');
                    if (!res.ok) throw new Error(res.statusText);
                    const data = await res.json();
                    fill(data.calibration || (data.data && data.data.calibration));
                    setStatus('å·²åˆ·æ–°', true);
                    showMessage('æ ‡å®šå‚æ•°å·²åˆ·æ–°', 'success');
                } catch (e) {
                    console.error('calibration refresh failed', e);
                    setStatus('åˆ·æ–°å¤±è´¥');
                    showMessage('æ ‡å®šåˆ·æ–°å¤±è´¥: ' + e.message, 'warn');
                }
            };

            const save = async () => {
                const payload = {
                    pixel_to_mm: parseFloat(pxmm.value || '0'),
                    offset_mm: parseFloat(offset.value || '0'),
                    latency_ms: parseFloat(latency.value || '0'),
                    belt_speed_mm_s: parseFloat(speed.value || '0'),
                    persist: true
                };
                try {
                    const res = await fetch('/api/calibration', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!res.ok) throw new Error(res.statusText);
                    const data = await res.json();
                    if (!data.ok) throw new Error('persist failed');
                    fill(data.calibration);
                    setStatus('å·²ä¿å­˜', true);
                    showMessage('æ ‡å®šå‚æ•°å·²ä¿å­˜', 'success');
                } catch (e) {
                    console.error('calibration save failed', e);
                    setStatus('ä¿å­˜å¤±è´¥');
                    showMessage('æ ‡å®šä¿å­˜å¤±è´¥: ' + e.message, 'error');
                }
            };

            const runCalibration = async (camera) => {
                try {
                    const res = await fetch('/api/calibration/run', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ camera })
                    });
                    const data = await res.json();
                    if (!data.ok) throw new Error(data.error || 'start failed');
                    setRunStatus(`è¿è¡Œä¸­ (pid=${data.pid || ''})`, true);
                    showMessage(`æ ‡å®šå¯åŠ¨: ${camera}`, 'success');
                } catch (e) {
                    setRunStatus('å¯åŠ¨å¤±è´¥');
                    showMessage('æ ‡å®šå¯åŠ¨å¤±è´¥: ' + e.message, 'error');
                }
            };

            const stopCalibration = async () => {
                try {
                    const res = await fetch('/api/calibration/stop', { method: 'POST' });
                    const data = await res.json();
                    if (!data.ok) throw new Error(data.error || 'stop failed');
                    setRunStatus('å·²åœæ­¢', true);
                    showMessage('æ ‡å®šå·²åœæ­¢', 'success');
                } catch (e) {
                    setRunStatus('åœæ­¢å¤±è´¥');
                    showMessage('æ ‡å®šåœæ­¢å¤±è´¥: ' + e.message, 'error');
                }
            };

            btnRefresh?.addEventListener('click', refresh);
            btnSave?.addEventListener('click', save);
            btnRunCam0?.addEventListener('click', () => runCalibration('csi://0'));
            btnRunCam1?.addEventListener('click', () => runCalibration('csi://1'));
            btnRunStop?.addEventListener('click', stopCalibration);
            refresh();
        })();

        console.log('AIç«¹èŠ‚è¯†åˆ«åˆ‡å‰²ç³»ç»Ÿ - æ— å¤´ç‰ˆé¢„è§ˆç•Œé¢å·²åŠ è½½');
    </script>
</body>
</html>
